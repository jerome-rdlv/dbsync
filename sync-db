#!/usr/bin/php
<?php

DbSync::run();

class DbSync
{
	public static $mysqlPath = 'mysql';
	public static $mysqlDumpPath = 'mysqldump';
	public static $confDefaultFile = 'sync-db.json';

	public static function run()
	{
		return new self();
	}

	private $config = null;

	private $args = null;

	private $srdb = '/tmp/srdb.cli.php';

	private $opts = array(
		'c:' => 'conf:',
		's:' => 'source:',
		't:' => 'target:',
		'o:' => 'output:',
		'r' => 'replacements-only',
		'n' => 'no-replacement',
		'h' => 'help',
		'd' => 'debug'
	);

	private $srdbOpts = array(
		't:' => 'tables:',
		'i:' => 'include-cols:',
		'x:' => 'exclude-cols:',
		'g' => 'regex'
	);

	private $options = null;

	private $colors = array(
		'no'     => '00',
		'grey'   => '37',
		'yellow' => '33',
		'red'    => '31',
		'green'  => '32',
		'blue'   => '34',
		'purple' => '35',
		'ocean'  => '36'
	);

	private $envs = null;

	private function __construct()
	{
		global $argv;
		$this->args = $argv;

		$this->script = basename($argv[0]);
		$this->options = getopt(
			implode('', array_keys($this->opts)),
			array_values($this->opts)
		);

		$this->srdb = str_replace('.cli.php', uniqid().'.php', $this->srdb);

		if ($this->getOpt('help')) {
			$this->help();
		}

		$this->loadConfig();
		$this->checkConnections();

		// everything ok, display confirm message
		if ($this->confirm()) {
			$this->proceed();
		}
	}

	private function confirm()
	{
		if ($this->getOpt('r')) {
			echo "\nReady to apply replacements:\n\n";
		}
		else {
			echo "\nReady to sync:\n\n";
		}

		$cData = 'grey';
		$cSymbol ='yellow';

		$items = array('from' => 'source');
		if ($this->getOpt('output')) {
			$items['to'] = 'file';
		}
		else {
			$items['to'] = 'target';
		}
		$out = array();

		// label
		$length = 0;
		foreach ($items as $key => $env) {
			$out[$env] = $key .' ';
			if ($env == 'file') {
				$out[$env] .= $this->c('file', 'no');
			}
			else {
				$out[$env] .= $this->c($this->envs[$env]['env'], 'yellow');
			}
			$out[$env] .= ':';
			$length = max($length, strlen($out[$env]));
		}

		// detail
		foreach ($items as $key => $env) {

			echo str_pad($out[$env], $length + 2, ' ', STR_PAD_LEFT) ."  ";

			if ($env == 'file') {
				echo $this->c($this->getOpt('output'), $cData);
			}
			else {
				$config = $this->envs[$env];
				echo $this->c($config['user'], $cData) . $this->c('@', $cSymbol);
				if (array_key_exists('ssh', $config)) {
					echo $this->c('localhost', $cData);
				}
				else {
					echo $this->c($config['host'], $cData);
				}
				echo $this->c('/', $cSymbol) . $this->c($config['base'], $cData);

				if (array_key_exists('ssh', $config)) {
					echo $this->c(' ssh:', $cSymbol) . $this->c($config['ssh'], $cData);
//					echo $this->c(']', $cSymbol);
				}
			}
			echo "\n";
		}

		$answer = readline("\nDo you confirm? (yo/N) ");
		return preg_match('/[yo]/', $answer);
	}

	/**
	 * @param string $key The long option name to get
	 * @return string|null The option value, null if not found
	 */
	private function getOpt($key)
	{
		foreach ($this->opts as $short => $long) {
			// option with value
			if ($key.':' == $long || $key.':' == $short) {
				$short = str_replace(':', '', $short);
				$long = str_replace(':', '', $long);
				if (array_key_exists($long, $this->options)) {
					return $this->options[$long];
				}
				elseif (array_key_exists($short, $this->options)) {
					return $this->options[$short];
				}
				else {
					return null;
				}
			}
			// option without value
			elseif ($key == $long || $key == $short) {
				if (array_key_exists($long, $this->options)) {
					return true;
				}
				elseif (array_key_exists($short, $this->options)) {
					return true;
				}
				else {
					return false;
				}
			}
		}
		return null;
	}

	private function checkConnections()
	{
		$mysqlCmd = 'echo "use {base};" | mysql -u "{user}" -p"{pass}" -h "{host}" "{base}"';
		foreach ($this->envs as $env => $config) {
			$vars = array(
				'base' => $config['base'],
				'user' => $config['user'],
				'pass' => $config['pass']
			);
			if (array_key_exists('ssh', $config)) {
				// access distant mysql through ssh
				$vars['ssh'] = $config['ssh'];
				$vars['host'] = 'localhost';
				$result = $this->exec($this->nvsprintf('ssh {ssh} \'' . $mysqlCmd . '\' 2>&1', $vars));
			}
			else {
				// try direct access
				$vars['host'] = $config['host'];
				$result = $this->exec($this->nvsprintf($mysqlCmd .' 2>&1', $vars));
			}
			if ($result) {
				$this->error('Connection error for '. $config['env'] .' environment.', $result);
			}
		}
	}

	private function loadConfig()
	{
		$confFile = $this->getOpt('conf');
		if (!$confFile) {
			$confFile = self::$confDefaultFile;
		}

		if (!file_exists($confFile)) {
			$this->error('Can not find config file ' . $confFile, true);
		}

		$this->config = json_decode(file_get_contents($confFile), true);


		// loading environments
		if (!array_key_exists('environments', $this->config) || !$this->config['environments']) {
			$this->error('No environment found in config.');
		}

		$msgEnvs = "Available environments: ";
		$envNames = array_keys($this->config['environments']);
		array_walk($envNames, function(&$item) {
			$item = $this->c($item, 'yellow');
		});
		$msgEnvs .= implode(', ', $envNames). "\n";

		if (!$this->getOpt('source')) {
			$this->error('Missing source environment', $msgEnvs, true);
		}
		if (!$this->getOpt('target') && !$this->getOpt('output')) {
			$this->error('Missing target environment or output file', $msgEnvs, true);
		}
		if ($this->getOpt('output')) {
			if ($this->getOpt('target')) {
				$this->error('Can not have a target environment and an output file');
			}

			$output = $this->getOpt('output');
			if (file_exists($output)) {
				if (is_writable($output)) {
					$this->warning('Output file exists');
				}
				else {
					$this->error('Output file is not writable');
				}
			}
			elseif (!is_writable(dirname($output))) {
				$this->error('Output file directory is not writable');
			}
		}

		$this->envs = array();
		$envs       = array('source');
		if ($this->getOpt('target')) {
			$envs[] = 'target';
		}

		foreach ($envs as $env) {
			$name = $this->getOpt($env);
			if (!$name) {
				$this->error("Please give the $env option", $msgEnvs);
			}
			elseif (!array_key_exists($name, $this->config['environments'])) {
				$this->error("Can not found $name in environments.", $msgEnvs);
			}
			else {
				$this->envs[$env] = $this->config['environments'][$name];
				$this->envs[$env]['env'] = $name;
			}
		}
	}

	private function error($msg, $detail ='', $help =false)
	{
		echo $this->c($msg, 'red')."\n";
		if ($detail) {
			echo $detail ."\n";
		}

		if ($help) {
			$this->help();
		}
		exit;
	}

	private function warning($msg, $detail ='')
	{
		echo $this->c($msg, 'red')."\n";
		if ($detail) {
			echo $detail ."\n";
		}
	}

	private function help()
	{
		echo "Usage : ". $this->script ." [-c config_file] -s source (-t target | -o output)\n";
		echo "    -c, --conf\n";
		echo "      Configuration file to read. Defaults to ". self::$confDefaultFile .".\n";
		echo "    -s, --source\n";
		echo "      Source environment name.\n";
		echo "    -t, --target\n";
		echo "      Target environment name.\n";
		echo "    -o, --output\n";
		echo "      Use output file instead of target.\n";
		echo "    -r, --replacements-only\n";
		echo "      No database transfert, replacements only.\n";
		echo "    -n, --no-replacements\n";
		echo "      Do not execute replacements, database transfert only.\n";
		echo "    -d, --debug\n";
		echo "      Debug mode, no shell_exec execution.\n";
		echo "    -h, --help\n";
		echo "      Disply this help.\n";
		exit;
	}

	private function doing($msg)
	{
		echo $this->c("  [ ] ", 'grey'). $msg;
	}

	private function done($msg =null)
	{
		echo "\r  ";
		echo $this->c("[✔]", 'green');
		if ($msg) {
			echo ' '. $msg;
		}
		echo "\n";
	}

	private function fail($msg =null)
	{
		echo "\r  ";
		echo $this->c("[✘]", 'red');
		if ($msg) {
			echo ' '. $msg;
		}
		echo "\n";
		exit;
	}

	/**
	 * @param $format
	 * @param $vars
	 */
	private function nvsprintf($format, $vars = array())
	{
		return preg_replace_callback('/{(.*?)}/', function ($matches) use ($vars) {
			if (array_key_exists($matches[1], $vars)) {
				return $vars[$matches[1]];
			}
			else {
				return $matches[0];
			}
		}, $format);
	}

	private function proceed()
	{
		echo "\n";
		$source = $this->envs['source'];
		$target = array_key_exists('target', $this->envs) ? $this->envs['target'] : null;

		// option “r” is for replacement only
		if (!$this->getOpt('r')) {
			$this->doing('database transfer...');

			$dumpCmd = '{mysqldump} -u "{user}" -p"{pass}" --add-drop-table --no-create-db -h "{host}" "{base}"';

			$sourceCmd = $this->nvsprintf($dumpCmd, array(
				'mysqldump' => self::$mysqlDumpPath,
				'user' => $source['user'],
				'pass' => $source['pass'],
				'base' => $source['base']
			));

			if (array_key_exists('ssh', $source)) {
				$sourceCmd = $this->nvsprintf('ssh {ssh} \''. $sourceCmd .'\'', array(
					'host' => 'localhost',
					'ssh' => $source['ssh']
				));
			}
			else {
				$sourceCmd = $this->nvsprintf($sourceCmd, array(
					'host' => $source['host']
				));
			}

			if ($this->getOpt('output')) {
				$output = $this->exec($sourceCmd . ' > "' . $this->getOpt('output'). '"', $result);
				if ($result != 0) {
					$this->fail($output);
				}
			}
			elseif ($target) {

				$tCmd = '{mysql} -u "{user}" -p"{pass}" -h "{host}" "{base}"';
				$tCmd = $this->nvsprintf($tCmd, array(
					'mysql' => self::$mysqlPath,
					'user' => $target['user'],
					'pass' => $target['pass'],
					'base' => $target['base']
				));
				if (array_key_exists('ssh', $target)) {
					$tCmd = $this->nvsprintf('ssh {ssh} \''. $tCmd .'\'', array(
						'host' => 'localhost',
						'ssh' => $target['ssh']
					));
				}
				else {
					$tCmd = $this->nvsprintf($tCmd, array(
						'host' => $target['host']
					));
				}
				$this->exec($sourceCmd .' | '. $tCmd);
			}
			$this->done('database transfer succeeded      ');
		}

		// option “n” means “no replacements”
		if (!$this->getOpt('n') && $target && array_key_exists('replacements', $this->config)) {
			$this->doing('replacements in database...');
			$cmds = array();
			$cmds['cp'] = 'echo "{data}" | php -r \'echo base64_decode(stream_get_contents(STDIN));\'';
			$cmds['chmod'] = 'chmod +x {srdb}';
			$cmds['rm'] = 'rm {srdb}';

			if (array_key_exists('ssh', $target)) {
				$cmds['cp'] = $this->nvsprintf($cmds['cp'] .' | ssh {ssh} \'cat > {srdb}\'', array(
					'ssh' => $target['ssh']
				));
				$cmds['chmod'] = $this->nvsprintf('ssh {ssh} \''. $cmds['chmod'] .'\'', array(
					'ssh' => $target['ssh']
				));
				$cmds['rm'] = $this->nvsprintf('ssh {ssh} \''. $cmds['rm'] .'\'', array(
					'ssh' => $target['ssh']
				));
			}
			else {
				$cmds['cp'] .= ' > {srdb}';
			}

			// copy srdb to tmp
			$this->exec($this->nvsprintf($cmds['cp'], array(
				'data' => $this->getSrdbData(),
				'srdb' => $this->srdb,
			)));

			// chmod +x
			$this->exec($this->nvsprintf($cmds['chmod'], array(
				'srdb' => $this->srdb,
			)));

			$replaceCmd = '{srdb} -n "{base}" -u "{user}" -p"{pass}" -h "{host}" -s"{search}" -r"{replace}" {options}';
			$replaceCmd = $this->nvsprintf($replaceCmd, array(
				'srdb' => $this->srdb,
				'base' => $target['base'],
				'user' => $target['user'],
				'pass' => $target['pass']
			));
			if (array_key_exists('ssh', $target)) {
				$replaceCmd = $this->nvsprintf('ssh {ssh} \''. $replaceCmd .'\'', array(
					'host' => 'localhost',
					'ssh' => $target['ssh']
				));
			}
			else {
				$replaceCmd = $this->nvsprintf($replaceCmd, array(
					'host' => $target['host']
				));
			}

			$count = 0;
			foreach ($this->config['replacements'] as $replacement) {
				if (!array_key_exists($source['env'], $replacement)) {
					continue;
				}
				if (!array_key_exists($target['env'], $replacement)) {
					continue;
				}
				// options
				$options = '';
				if (array_key_exists('tables', $replacement)) {
					$options = '-t "'. $replacement['tables'] .'"';
				}
				$this->exec($this->nvsprintf($replaceCmd, array(
					'search' => $replacement[$source['env']],
					'replace' => $replacement[$target['env']],
					'options' => $options
				)));
				++$count;
			}

			$this->exec($this->nvsprintf($cmds['rm'], array(
				'srdb' => $this->srdb
			)));
			$this->done($count .' replacements executed      ');
		}
		echo "\n";
	}

	private function exec($cmd, &$output =null)
	{
		if ($this->getOpt('debug')) {

			$lmax = 256;
			if (strlen($cmd) > $lmax) {
				echo "\n". substr($cmd, 0, $lmax/2) .' ... '. substr($cmd, strlen($cmd) - $lmax/2) ."\n";
			}
			else {
				echo "\n". $cmd ."\n";
			}
			return 0;
		}
		else {
			$output = '';
			$result = 0;
			exec($cmd, $output, $result);
			$output = implode("\n", $output);
			return $result;
		}
	}

	private function c($text, $color ='no', $bold =false)
	{
		if (array_key_exists($color, $this->colors)) {
			return "\033[".($bold?'1':'0').';'.$this->colors[$color].'m'.$text."\033[0m";
		}
		else {
			return $text;
		}
	}

	private function getSrdbData()
	{
		/* This is a base64_encode of the merge of `srdb.class.php` and `srdb.cli.php`
		 * from https://github.com/interconnectit/Search-Replace-DB */
		## SRDB-DATA ##
		return 'IyEvdXNyL2Jpbi9waHAgLXEKPD9waHAKCi8qKgogKiBUbyBydW4gdGhpcyBzY3JpcHQsIGV4ZWN1dGUgc29tZXRoaW5nIGxpa2UgdGhpczoKICogYC4vc3JkYi5jbGkucGhwIC1oIGxvY2FsaG9zdCAtdSByb290IC1uIHRlc3QgLXMgImZpbmRNZSIgLXIgInJlcGxhY2VNZSJgCiAqIHVzZSB0aGUgLS1kcnktcnVuIGZsYWcgdG8gZG8gYSBkcnkgcnVuIHdpdGhvdXQgc2VhcmNoaW5nL3JlcGxhY2luZy4KICovCgovLyBwaHAgNS4zIGRhdGUgdGltZXpvbmUgcmVxdWlyZW1lbnQsIHNob3VsZG4ndCBhZmZlY3QgYW55dGhpbmcKZGF0ZV9kZWZhdWx0X3RpbWV6b25lX3NldCggJ0V1cm9wZS9Mb25kb24nICk7CgovLyBpbmNsdWRlIHRoZSBzcmRiIGNsYXNzCi8vcmVxdWlyZV9vbmNlKHJlYWxwYXRoKGRpcm5hbWUoX19GSUxFX18pKSAuICcvc3JkYi5jbGFzcy5waHAnKTsKCiRvcHRzID0gYXJyYXkoCgknaDonID0+ICdob3N0OicsCgknbjonID0+ICduYW1lOicsCgkndTonID0+ICd1c2VyOicsCgkncDonID0+ICdwYXNzOicsCgknYzonID0+ICdjaGFyOicsCgknczonID0+ICdzZWFyY2g6JywKCSdyOicgPT4gJ3JlcGxhY2U6JywKCSd0OicgPT4gJ3RhYmxlczonLAoJJ2k6JyA9PiAnaW5jbHVkZS1jb2xzOicsCgkneDonID0+ICdleGNsdWRlLWNvbHM6JywKCSdnJyA9PiAncmVnZXgnLAoJJ2w6JyA9PiAncGFnZXNpemU6JywKCSd6JyA9PiAnZHJ5LXJ1bicsCgknZTonID0+ICdhbHRlci1lbmdpbmU6JywKCSdhOicgPT4gJ2FsdGVyLWNvbGxhdGlvbjonLAoJJ3Y6OicgPT4gJ3ZlcmJvc2U6OicsCgknaGVscCcKKTsKCiRyZXF1aXJlZCA9IGFycmF5KAoJJ2g6JywKCSduOicsCgkndTonLAoJJ3A6JwopOwoKZnVuY3Rpb24gc3RyaXBfY29sb25zKCAkc3RyaW5nICkgewoJcmV0dXJuIHN0cl9yZXBsYWNlKCAnOicsICcnLCAkc3RyaW5nICk7Cn0KCi8vIHN0b3JlIGFyZyB2YWx1ZXMKJGFyZ19jb3VudCAJPSAkX1NFUlZFUlsgJ2FyZ2MnIF07CiRhcmdzX2FycmF5ID0gJF9TRVJWRVJbICdhcmd2JyBdOwoKJHNob3J0X29wdHMgPSBhcnJheV9rZXlzKCAkb3B0cyApOwokc2hvcnRfb3B0c19ub3JtYWwgPSBhcnJheV9tYXAoICdzdHJpcF9jb2xvbnMnLCAkc2hvcnRfb3B0cyApOwoKJGxvbmdfb3B0cyA9IGFycmF5X3ZhbHVlcyggJG9wdHMgKTsKJGxvbmdfb3B0c19ub3JtYWwgPSBhcnJheV9tYXAoICdzdHJpcF9jb2xvbnMnLCAkbG9uZ19vcHRzICk7CgovLyBzdG9yZSBhcnJheSBvZiBvcHRpb25zIGFuZCB2YWx1ZXMKJG9wdGlvbnMgPSBnZXRvcHQoIGltcGxvZGUoICcnLCAkc2hvcnRfb3B0cyApLCAkbG9uZ19vcHRzICk7CgppZiAoIGlzc2V0KCAkb3B0aW9uc1sgJ2hlbHAnIF0gKSApIHsKCWVjaG8gIgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmludGVyY29ubmVjdC9pdCBTYWZlIFNlYXJjaCAmIFJlcGxhY2UgdG9vbAoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpUaGlzIHNjcmlwdCBhbGxvd3MgeW91IHRvIHNlYXJjaCBhbmQgcmVwbGFjZSBzdHJpbmdzIGluIHlvdXIgZGF0YWJhc2UKc2FmZWx5IHdpdGhvdXQgYnJlYWtpbmcgc2VyaWFsaXNlZCBQSFAuCgpQbGVhc2UgcmVwb3J0IGFueSBidWdzIG9yIGZvcmsgYW5kIGNvbnRyaWJ1dGUgdG8gdGhpcyBzY3JpcHQgdmlhCkdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL2ludGVyY29ubmVjdGl0L3NlYXJjaC1yZXBsYWNlLWRiCgpBcmd1bWVudCB2YWx1ZXMgYXJlIHN0cmluZ3MgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuCgpBUkdTCiAgLWgsIC0taG9zdAogICAgUmVxdWlyZWQuIFRoZSBob3N0bmFtZSBvZiB0aGUgZGF0YWJhc2Ugc2VydmVyLgogIC1uLCAtLW5hbWUKICAgIFJlcXVpcmVkLiBEYXRhYmFzZSBuYW1lLgogIC11LCAtLXVzZXIKICAgIFJlcXVpcmVkLiBEYXRhYmFzZSB1c2VyLgogIC1wLCAtLXBhc3MKICAgIFJlcXVpcmVkLiBEYXRhYmFzZSB1c2VyJ3MgcGFzc3dvcmQuCiAgLXMsIC0tc2VhcmNoCiAgICBTdHJpbmcgdG8gc2VhcmNoIGZvciBvciBgcHJlZ19yZXBsYWNlKClgIHN0eWxlCiAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgLXIsIC0tcmVwbGFjZQogICAgTm9uZSBlbXB0eSBzdHJpbmcgdG8gcmVwbGFjZSBzZWFyY2ggd2l0aCBvcgogICAgYHByZWdfcmVwbGFjZSgpYCBzdHlsZSByZXBsYWNlbWVudC4KICAtdCwgLS10YWJsZXMKICAgIElmIHNldCBvbmx5IHJ1bnMgdGhlIHNjcmlwdCBvbiB0aGUgc3BlY2lmaWVkIHRhYmxlLCBjb21tYQogICAgc2VwYXJhdGUgZm9yIG11bHRpcGxlIHZhbHVlcy4KICAtaSwgLS1pbmNsdWRlLWNvbHMKICAgIElmIHNldCBvbmx5IHJ1bnMgdGhlIHNjcmlwdCBvbiB0aGUgc3BlY2lmaWVkIGNvbHVtbnMsIGNvbW1hCiAgICBzZXBhcmF0ZSBmb3IgbXVsdGlwbGUgdmFsdWVzLgogIC14LCAtLWV4Y2x1ZGUtY29scwogICAgSWYgc2V0IGV4Y2x1ZGVzIHRoZSBzcGVjaWZpZWQgY29sdW1ucywgY29tbWEgc2VwYXJhdGUgZm9yCiAgICBtdWx0aXBsZSB2YWx1ZXMuCiAgLWcsIC0tcmVnZXggW25vIHZhbHVlXQogICAgVHJlYXRzIHZhbHVlIGZvciAtcyBvciAtLXNlYXJjaCBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiBhbmQKICAgIC1yIG9yIC0tcmVwbGFjZSBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiByZXBsYWNlbWVudC4KICAtbCwgLS1wYWdlc2l6ZQogICAgSG93IHJvd3MgdG8gZmV0Y2ggYXQgYSB0aW1lIGZyb20gYSB0YWJsZS4KICAteiwgLS1kcnktcnVuIFtubyB2YWx1ZV0KICAgIFByZXZlbnRzIGFueSB1cGRhdGVzIGhhcHBlbmluZyBzbyB5b3UgY2FuIHByZXZpZXcgdGhlIG51bWJlcgogICAgb2YgY2hhbmdlcyB0byBiZSBtYWRlCiAgLWUsIC0tYWx0ZXItZW5naW5lCiAgICBDaGFuZ2VzIHRoZSBkYXRhYmFzZSB0YWJsZSB0byB0aGUgc3BlY2lmaWVkIGRhdGFiYXNlIGVuZ2luZQogICAgZWcuIElubm9EQiBvciBNeUlTQU0uIElmIHNwZWNpZmllZCBzZWFyY2gvcmVwbGFjZSBhcmd1bWVudHMKICAgIGFyZSBpZ25vcmVkLiBUaGV5IHdpbGwgbm90IGJlIHJ1biBzaW11bHRhbmVvdXNseS4KICAtYSwgLS1hbHRlci1jb2xsYXRpb24KICAgIENoYW5nZXMgdGhlIGRhdGFiYXNlIHRhYmxlIHRvIHRoZSBzcGVjaWZpZWQgY29sbGF0aW9uCiAgICBlZy4gdXRmOF91bmljb2RlX2NpLiBJZiBzcGVjaWZpZWQgc2VhcmNoL3JlcGxhY2UgYXJndW1lbnRzCiAgICBhcmUgaWdub3JlZC4gVGhleSB3aWxsIG5vdCBiZSBydW4gc2ltdWx0YW5lb3VzbHkuCiAgLXYsIC0tdmVyYm9zZSBbdHJ1ZXxmYWxzZV0KICAgIERlZmF1bHRzIHRvIHRydWUsIGNhbiBiZSBzZXQgdG8gZmFsc2UgdG8gcnVuIHNjcmlwdCBzaWxlbnRseS4KICAtLWhlbHAKICAgIERpc3BsYXlzIHRoaXMgaGVscCBtZXNzYWdlIDspCiI7CglleGl0Owp9CgovLyBtaXNzaW5nIGZpZWxkIGZsYWcsIHNob3cgYWxsIG1pc3NpbmcgaW5zdGVhZCBvZiAxIGF0IGEgdGltZQokbWlzc2luZ19hcmcgPSBmYWxzZTsKCi8vIGNoZWNrIHJlcXVpcmVkIGFyZ3MgYXJlIHBhc3NlZApmb3JlYWNoKCAkcmVxdWlyZWQgYXMgJGtleSApIHsKCSRzaG9ydF9vcHQgPSBzdHJpcF9jb2xvbnMoICRrZXkgKTsKCSRsb25nX29wdCA9IHN0cmlwX2NvbG9ucyggJG9wdHNbICRrZXkgXSApOwoJaWYgKCAhIGlzc2V0KCAkb3B0aW9uc1sgJHNob3J0X29wdCBdICkgJiYgISBpc3NldCggJG9wdGlvbnNbICRsb25nX29wdCBdICkgKSB7CgkJZndyaXRlKCBTVERFUlIsICJFcnJvcjogTWlzc2luZyBhcmd1bWVudCwgLXskc2hvcnRfb3B0fSBvciAtLXskbG9uZ19vcHR9IGlzIHJlcXVpcmVkLlxuIiApOwoJCSRtaXNzaW5nX2FyZyA9IHRydWU7Cgl9Cn0KCi8vIGJhaWwgaWYgcmVxdWlyZW1lbnRzIG5vdCBtZXQKaWYgKCAkbWlzc2luZ19hcmcgKSB7Cglmd3JpdGUoIFNUREVSUiwgIlBsZWFzZSBlbnRlciB0aGUgbWlzc2luZyBhcmd1bWVudHMuXG4iICk7CglleGl0KCAxICk7Cn0KCi8vIG5ldyBhcmdzIGFycmF5CiRhcmdzID0gYXJyYXkoCgkndmVyYm9zZScgPT4gdHJ1ZSwKCSdkcnlfcnVuJyA9PiBmYWxzZQopOwoKLy8gY3JlYXRlICRhcmdzIGFycmF5CmZvcmVhY2goICRvcHRpb25zIGFzICRrZXkgPT4gJHZhbHVlICkgewoKCS8vIHRyYW5zcG9zZSBrZXlzCglpZiAoICggJGlzX3Nob3J0ID0gYXJyYXlfc2VhcmNoKCAka2V5LCAkc2hvcnRfb3B0c19ub3JtYWwgKSApICE9PSBmYWxzZSApCgkJJGtleSA9ICRsb25nX29wdHNfbm9ybWFsWyAkaXNfc2hvcnQgXTsKCgkvLyB0cnVlL2ZhbHNlIHN0cmluZyBtYXBwaW5nCglpZiAoIGlzX3N0cmluZyggJHZhbHVlICkgJiYgaW5fYXJyYXkoICR2YWx1ZSwgYXJyYXkoICdmYWxzZScsICdubycsICcwJyApICkgKQoJCSR2YWx1ZSA9IGZhbHNlOwoJaWYgKCBpc19zdHJpbmcoICR2YWx1ZSApICYmIGluX2FycmF5KCAkdmFsdWUsIGFycmF5KCAndHJ1ZScsICd5ZXMnLCAnMScgKSApICkKCQkkdmFsdWUgPSB0cnVlOwoKCS8vIGJvb2xlYW4gb3B0aW9ucyBhcyBpcywgZWcuIGEgbm8gdmFsdWUgYXJnIHNob3VsZCBiZSBzZXQgdHJ1ZQoJaWYgKCBpbl9hcnJheSggJGtleSwgJGxvbmdfb3B0cyApICkKCQkkdmFsdWUgPSB0cnVlOwoKCS8vIGNoYW5nZSB0byB1bmRlcnNjb3JlcwoJJGtleSA9IHN0cl9yZXBsYWNlKCAnLScsICdfJywgJGtleSApOwoKCSRhcmdzWyAka2V5IF0gPSAkdmFsdWU7Cn0KCi8vIG1vZGlmeSB0aGUgbG9nIG91dHB1dApjbGFzcyBpY2l0X3NyZGJfY2xpIGV4dGVuZHMgaWNpdF9zcmRiIHsKCglwdWJsaWMgZnVuY3Rpb24gbG9nKCAkdHlwZSA9ICcnICkgewoKCQkkYXJncyA9IGFycmF5X3NsaWNlKCBmdW5jX2dldF9hcmdzKCksIDEgKTsKCgkJJG91dHB1dCA9ICIiOwoKCQlzd2l0Y2goICR0eXBlICkgewoJCQljYXNlICdlcnJvcic6CgkJCQlsaXN0KCAkZXJyb3JfdHlwZSwgJGVycm9yICkgPSAkYXJnczsKCQkJCSRvdXRwdXQgLj0gIiRlcnJvcl90eXBlOiAkZXJyb3IiOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ3NlYXJjaF9yZXBsYWNlX3RhYmxlX3N0YXJ0JzoKCQkJCWxpc3QoICR0YWJsZSwgJHNlYXJjaCwgJHJlcGxhY2UgKSA9ICRhcmdzOwoJCQkJJG91dHB1dCAuPSAieyR0YWJsZX06IHJlcGxhY2luZyB7JHNlYXJjaH0gd2l0aCB7JHJlcGxhY2V9IjsKCQkJCWJyZWFrOwoJCQljYXNlICdzZWFyY2hfcmVwbGFjZV90YWJsZV9lbmQnOgoJCQkJbGlzdCggJHRhYmxlLCAkcmVwb3J0ICkgPSAkYXJnczsKCQkJCSR0aW1lID0gbnVtYmVyX2Zvcm1hdCggJHJlcG9ydFsgJ2VuZCcgXSAtICRyZXBvcnRbICdzdGFydCcgXSwgOCApOwoJCQkJJG91dHB1dCAuPSAieyR0YWJsZX06IHskcmVwb3J0Wydyb3dzJ119IHJvd3MsIHskcmVwb3J0WydjaGFuZ2UnXX0gY2hhbmdlcyBmb3VuZCwgeyRyZXBvcnRbJ3VwZGF0ZXMnXX0gdXBkYXRlcyBtYWRlIGluIHskdGltZX0gc2Vjb25kcyI7CgkJCQlicmVhazsKCQkJY2FzZSAnc2VhcmNoX3JlcGxhY2VfZW5kJzoKCQkJCWxpc3QoICRzZWFyY2gsICRyZXBsYWNlLCAkcmVwb3J0ICkgPSAkYXJnczsKCQkJCSR0aW1lID0gbnVtYmVyX2Zvcm1hdCggJHJlcG9ydFsgJ2VuZCcgXSAtICRyZXBvcnRbICdzdGFydCcgXSwgOCApOwoJCQkJJGRyeV9ydW5fc3RyaW5nID0gJHRoaXMtPmRyeV9ydW4gPyAid291bGQgaGF2ZSBiZWVuIiA6ICJ3ZXJlIjsKCQkJCSRvdXRwdXQgLj0gIgpSZXBsYWNpbmcgeyRzZWFyY2h9IHdpdGggeyRyZXBsYWNlfSBvbiB7JHJlcG9ydFsndGFibGVzJ119IHRhYmxlcyB3aXRoIHskcmVwb3J0Wydyb3dzJ119IHJvd3MKeyRyZXBvcnRbJ2NoYW5nZSddfSBjaGFuZ2VzIHskZHJ5X3J1bl9zdHJpbmd9IG1hZGUKeyRyZXBvcnRbJ3VwZGF0ZXMnXX0gdXBkYXRlcyB3ZXJlIGFjdHVhbGx5IG1hZGUKSXQgdG9vayB7JHRpbWV9IHNlY29uZHMiOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ3VwZGF0ZV9lbmdpbmUnOgoJCQkJbGlzdCggJHRhYmxlLCAkcmVwb3J0LCAkZW5naW5lICkgPSAkYXJnczsKCQkJCSRvdXRwdXQgLj0gJHRhYmxlIC4gKCAkcmVwb3J0WyAnY29udmVydGVkJyBdWyAkdGFibGUgXSA/ICcgaGFzIGJlZW4nIDogJ2hhcyBub3QgYmVlbicgKSAuICcgY29udmVydGVkIHRvICcgLiAkZW5naW5lOwoJCQkJYnJlYWs7CgkJCWNhc2UgJ3VwZGF0ZV9jb2xsYXRpb24nOgoJCQkJbGlzdCggJHRhYmxlLCAkcmVwb3J0LCAkY29sbGF0aW9uICkgPSAkYXJnczsKCQkJCSRvdXRwdXQgLj0gJHRhYmxlIC4gKCAkcmVwb3J0WyAnY29udmVydGVkJyBdWyAkdGFibGUgXSA/ICcgaGFzIGJlZW4nIDogJ2hhcyBub3QgYmVlbicgKSAuICcgY29udmVydGVkIHRvICcgLiAkY29sbGF0aW9uOwoJCQkJYnJlYWs7CgkJfQoKCQlpZiAoICR0aGlzLT52ZXJib3NlICkKCQkJZWNobyAkb3V0cHV0IC4gIlxuIjsKCgl9Cgp9CgokcmVwb3J0ID0gbmV3IGljaXRfc3JkYl9jbGkoICRhcmdzICk7CgovLyBPbmx5IHByaW50IGEgc2VwYXJhdGluZyBuZXdsaW5lIGlmIHZlcmJvc2UgbW9kZSBpcyBvbiB0byBzZXBhcmF0ZSB2ZXJib3NlIG91dHB1dCBmcm9tIHJlc3VsdAppZiAoJGFyZ3NbICd2ZXJib3NlJyBdKSB7CgllY2hvICJcbiI7Cn0KCmlmICggJHJlcG9ydCAmJiAoICggaXNzZXQoICRhcmdzWyAnZHJ5X3J1bicgXSApICYmICRhcmdzWyAnZHJ5X3J1bicgXSApIHx8IGVtcHR5KCAkcmVwb3J0LT5lcnJvcnNbICdyZXN1bHRzJyBdICkgKSApIHsKCWVjaG8gIkFuZCB3ZSdyZSBkb25lIVxuIjsKfSBlbHNlIHsKCWVjaG8gIkNoZWNrIHRoZSBvdXRwdXQgZm9yIGVycm9ycy4gWW91IG1heSBuZWVkIHRvIGVuc3VyZSB2ZXJib3NlIG91dHB1dCBpcyBvbiBieSB1c2luZyAtdiBvciAtLXZlcmJvc2UuXG4iOwp9CgovLyBDTEFTUyBGSUxFIHNyZGIuY2xhc3MucGhwCgovKioKICoKICogU2FmZSBTZWFyY2ggYW5kIFJlcGxhY2Ugb24gRGF0YWJhc2Ugd2l0aCBTZXJpYWxpemVkIERhdGEgdjMuMC4wCiAqCiAqIFRoaXMgc2NyaXB0IGlzIHRvIHNvbHZlIHRoZSBwcm9ibGVtIG9mIGRvaW5nIGRhdGFiYXNlIHNlYXJjaCBhbmQgcmVwbGFjZSB3aGVuCiAqIHNvbWUgZGF0YSBpcyBzdG9yZWQgd2l0aGluIFBIUCBzZXJpYWxpemVkIGFycmF5cyBvciBvYmplY3RzLgogKgogKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCiAqIGh0dHA6Ly9pbnRlcmNvbm5lY3RpdC5jb20vMTI0L3NlYXJjaC1hbmQtcmVwbGFjZS1mb3Itd29yZHByZXNzLWRhdGFiYXNlcy8KICoKICogVG8gY29udHJpYnV0ZSBnbyB0bwogKiBodHRwOi8vZ2l0aHViLmNvbS9pbnRlcmNvbm5lY3RpdC9zZWFyY2gtcmVwbGFjZS1kYgogKgogKiBUbyB1c2UsIGxvYWQgdGhlIHNjcmlwdCBvbiB5b3VyIHNlcnZlciBhbmQgcG9pbnQgeW91ciB3ZWIgYnJvd3NlciB0byBpdC4KICogSW4gc29tZSBzaXR1YXRpb25zLCBjb25zaWRlciB1c2luZyB0aGUgY29tbWFuZCBsaW5lIGludGVyZmFjZSB2ZXJzaW9uLgogKgogKiBCSUcgV0FSTklORyEgIFRha2UgYSBiYWNrdXAgZmlyc3QsIGFuZCBjYXJlZnVsbHkgdGVzdCB0aGUgcmVzdWx0cyBvZiB0aGlzCiAqIGNvZGUuIElmIHlvdSBkb24ndCwgYW5kIHlvdSB2YXBlIHlvdXIgZGF0YSB0aGVuIHlvdSBvbmx5IGhhdmUgeW91cnNlbGYgdG8KICogYmxhbWUuIFNlcmlvdXNseS4gIEFuZCBpZiB5b3VyIEVuZ2xpc2ggaXMgYmFkIGFuZCB5b3UgZG9uJ3QgZnVsbHkKICogdW5kZXJzdGFuZCB0aGUgaW5zdHJ1Y3Rpb25zIHRoZW4gU1RPUC4gUmlnaHQgdGhlcmUuIFllcy4gQmVmb3JlIHlvdSBkbyBhbnkKICogZGFtYWdlLgogKgogKiBVU0UgT0YgVEhJUyBTQ1JJUFQgSVMgRU5USVJFTFkgQVQgWU9VUiBPV04gUklTSy4gSS9XZSBhY2NlcHQgbm8gbGlhYmlsaXR5CiAqIGZyb20gaXRzIHVzZS4KICoKICogRmlyc3QgV3JpdHRlbiAyMDA5LTA1LTI1IGJ5IERhdmlkIENvdmVuZXkgb2YgSW50ZXJjb25uZWN0IElUIEx0ZCAoVUspCiAqIGh0dHA6Ly93d3cuZGF2aWRjb3ZlbmV5LmNvbSBvciBodHRwOi8vaW50ZXJjb25uZWN0aXQuY29tCiAqIGFuZCByZWxlYXNlZCB1bmRlciB0aGUgR1BMIHYzCiAqIGllLCBkbyB3aGF0IGV2ZXIgeW91IHdhbnQgd2l0aCB0aGUgY29kZSwgYW5kIHdlIHRha2Ugbm8gcmVzcG9uc2liaWxpdHkgZm9yIGl0CiAqIE9LPyBJZiB5b3UgZG9uJ3Qgd2lzaCB0byB0YWtlIHJlc3BvbnNpYmlsaXR5LCBoaXJlIHVzIGF0IEludGVyY29ubmVjdCBJVCBMdGQKICogb24gKzQ0ICgwKTE1MSAzMzEgNTE0MCBhbmQgd2Ugd2lsbCBkbyB0aGUgd29yayBmb3IgeW91IGF0IG91ciBob3VybHkgcmF0ZSwKICogbWluaW11bSAxaHIKICoKICogTGljZW5zZTogR1BMIHYzCiAqIExpY2Vuc2UgVVJMOiBodHRwOi8vd3d3LmdudS5vcmcvY29weWxlZnQvZ3BsLmh0bWwKICoKICoKICogVmVyc2lvbiAzLjA6CiAqIAkJKiBNYWpvciBvdmVyaGF1bAogKiAJCSogTXVsdGlieXRlIHN0cmluZyByZXBsYWNlbWVudHMKICogCQkqIENvbnZlcnQgdGFibGVzIHRvIElubm9EQgogKiAJCSogQ29udmVydCB0YWJsZXMgdG8gdXRmOF91bmljb2RlX2NpCiAqIAkJKiBQcmV2aWV3L3ZpZXcgY2hhbmdlcyBpbiByZXBvcnQKICogCQkqIE9wdGlvbmFsbHkgdXNlIHByZWdfcmVwbGFjZSgpCiAqIAkJKiBCZXR0ZXIgZXJyb3IvZXhjZXB0aW9uIGhhbmRsaW5nICYgcmVwb3J0aW5nCiAqIAkJKiBSZXBvcnRzIHBlciB0YWJsZQogKiAJCSogRXhjbHVkZS9pbmNsdWRlIG11bHRpcGxlIGNvbHVtbnMKICoKICogVmVyc2lvbiAyLjIuMDoKICogCQkqIEFkZGVkIHJlbW92ZSBzY3JpcHQgcGF0Y2ggZnJvbSBEYXZpZCBBbmRlcnNvbiAod29yZHNoZWxsLm5ldCkKICogCQkqIEFkZGVkIGFiaWxpdHkgdG8gcmVwbGFjZSBzdHJpbmdzIHdpdGggbm90aGluZwogKgkJKiBDb3B5IGNoYW5nZXMKICogCQkqIEFkZGVkIGNvZGUgdG8gcmVjdXJzaXZlX3Vuc2VyaWFsaXplX3JlcGxhY2UgdG8gZGVhbCB3aXRoIG9iamVjdHMgbm90CiAqIAkJanVzdCBhcnJheXMuIFRoaXMgd2FzIHN1Ym1pdHRlZCBieSBUaW5hIE1hdHRlci4KICogCQlUb0RvOiBUZXN0IG9iamVjdCBoYW5kbGluZy4gTm90IHN1cmUgaG93IGl0IHdpbGwgY29wZSB3aXRoIG9iamVjdCBpbiB0aGUKICogCQlkYiBjcmVhdGVkIHdpdGggY2xhc3NlcyB0aGF0IGRvbid0IGV4aXN0IGluIGFueXRoaW5nIGJ1dCB0aGUgYmFzZSBQSFAuCiAqCiAqIFZlcnNpb24gMi4xLjA6CiAqICAgICAgICAgICAgICAtIENoYW5nZWQgdG8gdmVyc2lvbiAyLjEuMAogKgkJKiBGb2xsb3dpbmcgY2hhbmdlIGJ5IFNlcmdlaSBCaXJ5dWtvdiAtIG1lcmdlZCBpbiBhbmQgdGVzdGVkIGJ5IERhdmUgQ292ZW5leQogKiAgICAgICAgICAgICAgLSBBZGRlZCBDaGFyc2V0IFN1cHBvcnQgKHRlc3RlZCB3aXRoIFVURi04LCBub3QgdGVzdGVkIG9uIG90aGVyIGNoYXJzZXRzKQogKgkJKiBGb2xsb3dpbmcgY2hhbmdlcyBpbXBsZW1lbnRlZCBieSBKYW1lcyBXaGl0ZWhlYWQgd2l0aCB0aGFua3MgdG8gYWxsIHRoZSBjb21tZW50ZXJzIGFuZCBmZWVkYmFjayBnaXZlbiEKICogCQktIFJlbW92ZWQgUEhQIHdhcm5pbmdzIGlmIHlvdSBnbyB0byBzdGVwIDMrIHdpdGhvdXQgREIgZGV0YWlscy4KICogCQktIEFkZGVkIG9wdGlvbnMgdG8gc2tpcCBjaGFuZ2luZyB0aGUgZ3VpZCBjb2x1bW4uIElmIHRoZXJlIGFyZSBvdGhlcgogKiAJCWNvbHVtbnMgdGhhdCBuZWVkIGV4Y2x1ZGluZyB5b3UgY2FuIGFkZCB0aGVtIHRvIHRoZSAkZXhjbHVkZV9jb2xzIGdsb2JhbAogKiAJCWFycmF5LiBNYXkgY2hvb3NlIHRvIGFkZCBhbm90aGVyIG9wdGlvbiB0byB0aGUgdGFibGUgc2VsZWN0IHBhZ2UgdG8gbGV0CiAqIAkJeW91IGFkZCB0byB0aGlzIGFycmF5IGZyb20gdGhlIGZyb250IGVuZC4KICogCQktIE1pbm9yIHR3ZWFrIHRvIGxhYmVsIHN0eWxpbmcuCiAqIAkJLSBBZGRlZCBjb21tZW50cyB0byBlYWNoIG9mIHRoZSBmdW5jdGlvbnMuCiAqIAkJLSBSZW1vdmVkIGEgZGVhZCBwYXJhbSBmcm9tIGljaXRfc3JkYl9yZXBsYWNlcgogKiBWZXJzaW9uIDIuMC4wOgogKiAJCS0gcmV0dXJuZWQgdG8gdXNpbmcgdW5zZXJpYWxpemUgZnVuY3Rpb24gdG8gY2hlY2sgaWYgc3RyaW5nIGlzCiAqIAkJc2VyaWFsaXplZCBvciBub3QKICogCQktIG1hcmtlZCBpc19zZXJpYWxpemVkX3N0cmluZyBmdW5jdGlvbiBhcyBkZXByZWNhdGVkCiAqIAkJLSBjaGFuZ2VkIGZvcm0gb3JkZXIgdG8gaW1wcm92ZSB1c2FiaWxpdHkgYW5kIG1ha2UgdXNlIG9uIG11bHRpc2l0ZXMgYQogKiAJCWJpdCBsZXNzIHNjYXJ5CiAqIAkJLSBjaGFuZ2VkIHRvIHZlcnNpb24gMiwgYXMgcmVhbGx5IHNob3VsZCBoYXZlIGRvbmUgd2hlbiB0aGUgVUkgd2FzCiAqIAkJaW50cm9kdWNlZAogKiAJCS0gYWRkZWQgYSByZWN1cnNpdmUgYXJyYXkgd2Fsa2VyIHRvIGRlYWwgd2l0aCBzZXJpYWxpemVkIHN0cmluZ3MgYmVpbmcKICogCQlzdG9yZWQgaW4gc2VyaWFsaXplZCBzdHJpbmdzLiBZZXMsIHJlYWxseS4KICogCQktIGNoYW5nZXMgYnkgSmFtZXMgUiBXaGl0ZWhlYWQgKGt1ZG9zIGZvciByZWN1cnNpdmUgd2Fsa2VyKSBhbmQgRGF2aWQKICogCQlDb3ZlbmV5IDIwMTEtMDgtMjYKICogIFZlcnNpb24gMS4wLjI6CiAqICAJLSB0eXBvcyBjb3JyZWN0ZWQsIGJ1dHRvbiB0ZXh0IHR3ZWFrIC0gRGF2aWQgQ292ZW5leSAvIFJvYmVydCBPJ1JvdXJrZQogKiAgVmVyc2lvbiAxLjAuMQogKiAgCS0gc3R5bGluZyBhbmQgZm9ybSBhZGRlZCBieSBKYW1lcyBSIFdoaXRlaGVhZC4KICoKICogIENyZWRpdHM6ICBtb3o2NjcgYXQgZ21haWwgZG90IGNvbSBmb3IgaGlzIHJlY3Vyc2l2ZV9hcnJheV9yZXBsYWNlIHBvc3RlZCBhdAogKiAgICAgICAgICAgIHVrLnBocC5uZXQgd2hpY2ggc2F2ZWQgbWUgYSBsaXR0bGUgdGltZSAtIGEgcGVyZmVjdCBzYW1wbGUgZm9yIG1lCiAqICAgICAgICAgICAgYW5kIHNlZW1zIHRvIHdvcmsgaW4gYWxsIGNhc2VzLgogKgogKi8KCmNsYXNzIGljaXRfc3JkYiB7CgoJLyoqCgkgKiBAdmFyIGFycmF5IExpc3Qgb2YgYWxsIHRoZSB0YWJsZXMgaW4gdGhlIGRhdGFiYXNlCgkgKi8KCXB1YmxpYyAkYWxsX3RhYmxlcyA9IGFycmF5KCk7CgoJLyoqCgkgKiBAdmFyIGFycmF5IFRhYmxlcyB0byBydW4gdGhlIHJlcGxhY2VtZW50IG9uCgkgKi8KCXB1YmxpYyAkdGFibGVzID0gYXJyYXkoKTsKCgkvKioKCSAqIEB2YXIgc3RyaW5nIFNlYXJjaCB0ZXJtCgkgKi8KCXB1YmxpYyAkc2VhcmNoID0gZmFsc2U7CgoJLyoqCgkgKiBAdmFyIHN0cmluZyBSZXBsYWNlbWVudAoJICovCglwdWJsaWMgJHJlcGxhY2UgPSBmYWxzZTsKCgkvKioKCSAqIEB2YXIgYm9vbCBVc2UgcmVndWxhciBleHByZXNzaW9ucyB0byBwZXJmb3JtIHNlYXJjaCBhbmQgcmVwbGFjZQoJICovCglwdWJsaWMgJHJlZ2V4ID0gZmFsc2U7CgoJLyoqCgkgKiBAdmFyIGJvb2wgTGVhdmUgZ3VpZCBjb2x1bW4gYWxvbmUKCSAqLwoJcHVibGljICRndWlkID0gZmFsc2U7CgoKCS8qKgoJICogQHZhciBhcnJheSBBdmFpbGFibGUgZW5naW5lcwoJICovCglwdWJsaWMgJGVuZ2luZXMgPSBhcnJheSgpOwoKCS8qKgoJICogQHZhciBib29sfHN0cmluZyBDb252ZXJ0IHRvIG5ldyBlbmdpbmUKCSAqLwoJcHVibGljICRhbHRlcl9lbmdpbmUgPSBmYWxzZTsKCgkvKioKCSAqIEB2YXIgYm9vbHxzdHJpbmcgQ29udmVydCB0byBuZXcgY29sbGF0aW9uCgkgKi8KCXB1YmxpYyAkYWx0ZXJfY29sbGF0ZSA9IGZhbHNlOwoKCS8qKgoJICogQHZhciBhcnJheSBDb2x1bW4gbmFtZXMgdG8gZXhjbHVkZQoJICovCglwdWJsaWMgJGV4Y2x1ZGVfY29scyA9IGFycmF5KCk7CgoJLyoqCgkgKiBAdmFyIGFycmF5IENvbHVtbiBuYW1lcyB0byBpbmNsdWRlCgkgKi8KCXB1YmxpYyAkaW5jbHVkZV9jb2xzID0gYXJyYXkoKTsKCgkvKioKCSAqIEB2YXIgYm9vbCBUcnVlIGlmIGRvaW5nIGEgZHJ5IHJ1bgoJICovCglwdWJsaWMgJGRyeV9ydW4gPSB0cnVlOwoKCS8qKgoJICogQHZhciBzdHJpbmcgRGF0YWJhc2UgY29ubmVjdGlvbiBkZXRhaWxzCgkgKi8KCXB1YmxpYyAkbmFtZSA9ICcnOwoJcHVibGljICR1c2VyID0gJyc7CglwdWJsaWMgJHBhc3MgPSAnJzsKCXB1YmxpYyAkaG9zdCA9ICcxMjcuMC4wLjEnOwoJcHVibGljICRjaGFyc2V0ID0gJ3V0ZjgnOwoJcHVibGljICRjb2xsYXRlID0gJyc7CgoKCS8qKgoJICogQHZhciBhcnJheSBTdG9yZXMgYSBsaXN0IG9mIGV4Y2VwdGlvbnMKCSAqLwoJcHVibGljICRlcnJvcnMgPSBhcnJheSgKCQknc2VhcmNoJyA9PiBhcnJheSgpLAoJCSdkYicgPT4gYXJyYXkoKSwKCQkndGFibGVzJyA9PiBhcnJheSgpLAoJCSdyZXN1bHRzJyA9PiBhcnJheSgpCgkpOwoKCXB1YmxpYyAkZXJyb3JfdHlwZSA9ICdzZWFyY2gnOwoKCgkvKioKCSAqIEB2YXIgYXJyYXkgU3RvcmVzIHRoZSByZXBvcnQgYXJyYXkKCSAqLwoJcHVibGljICRyZXBvcnQgPSBhcnJheSgpOwoKCgkvKioKCSAqIEB2YXIgaW50IE51bWJlciBvZiBtb2RpZmljYXRpb25zIHRvIHJldHVybiBpbiByZXBvcnQgYXJyYXkKCSAqLwoJcHVibGljICRyZXBvcnRfY2hhbmdlX251bSA9IDMwOwoKCgkvKioKCSAqIEB2YXIgYm9vbCBXaGV0aGVyIHRvIGVjaG8gcmVwb3J0IGFzIHNjcmlwdCBydW5zCgkgKi8KCXB1YmxpYyAkdmVyYm9zZSA9IGZhbHNlOwoKCgkvKioKCSAqIEB2YXIgcmVzb3VyY2UgRGF0YWJhc2UgY29ubmVjdGlvbgoJICovCglwdWJsaWMgJGRiOwoKCgkvKioKCSAqIEB2YXIgdXNlIFBETwoJICovCglwdWJsaWMgJHVzZV9wZG8gPSB0cnVlOwoKCgkvKioKCSAqIEB2YXIgaW50IEhvdyBtYW55IHJvd3MgdG8gc2VsZWN0IGF0IGEgdGltZSB3aGVuIHJlcGxhY2luZwoJICovCglwdWJsaWMgJHBhZ2Vfc2l6ZSA9IDUwMDAwOwoKCgkvKioKCSAqIFNlYXJjaGVzIGZvciBXUCBvciBEcnVwYWwgY29udGV4dAoJICogQ2hlY2tzIGZvciAkX1BPU1QgZGF0YQoJICogSW5pdGlhbGlzZXMgZGF0YWJhc2UgY29ubmVjdGlvbgoJICogSGFuZGxlcyBhamF4CgkgKiBSdW5zIHJlcGxhY2VtZW50CgkgKgoJICogQHBhcmFtIHN0cmluZyAkbmFtZSAgICBkYXRhYmFzZSBuYW1lCgkgKiBAcGFyYW0gc3RyaW5nICR1c2VyICAgIGRhdGFiYXNlIHVzZXJuYW1lCgkgKiBAcGFyYW0gc3RyaW5nICRwYXNzICAgIGRhdGFiYXNlIHBhc3N3b3JkCgkgKiBAcGFyYW0gc3RyaW5nICRob3N0ICAgIGRhdGFiYXNlIGhvc3RuYW1lCgkgKiBAcGFyYW0gc3RyaW5nICRzZWFyY2ggIHNlYXJjaCBzdHJpbmcgLyByZWdleAoJICogQHBhcmFtIHN0cmluZyAkcmVwbGFjZSByZXBsYWNlbWVudCBzdHJpbmcKCSAqIEBwYXJhbSBhcnJheSAkdGFibGVzICB0YWJsZXMgdG8gcnVuIHJlcGxjZW1lbnRzIGFnYWluc3QKCSAqIEBwYXJhbSBib29sICRsaXZlICAgIGxpdmUgcnVuCgkgKiBAcGFyYW0gYXJyYXkgJGV4Y2x1ZGVfY29scyAgdGFibGVzIHRvIHJ1biByZXBsY2VtZW50cyBhZ2FpbnN0CgkgKgoJICogQHJldHVybiB2b2lkCgkgKi8KCXB1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCggJGFyZ3MgKSB7CgoJCSRhcmdzID0gYXJyYXlfbWVyZ2UoIGFycmF5KAoJCQknbmFtZScgCQkJCT0+ICcnLAoJCQkndXNlcicgCQkJCT0+ICcnLAoJCQkncGFzcycgCQkJCT0+ICcnLAoJCQknaG9zdCcgCQkJCT0+ICcnLAoJCQknc2VhcmNoJyAJCQk9PiAnJywKCQkJJ3JlcGxhY2UnIAkJCT0+ICcnLAoJCQkndGFibGVzJwkJCT0+IGFycmF5KCksCgkJCSdleGNsdWRlX2NvbHMnIAkJPT4gYXJyYXkoKSwKCQkJJ2luY2x1ZGVfY29scycgCQk9PiBhcnJheSgpLAoJCQknZHJ5X3J1bicgCQkJPT4gdHJ1ZSwKCQkJJ3JlZ2V4JyAJCQk9PiBmYWxzZSwKCQkJJ3BhZ2VzaXplJyAJCQk9PiA1MDAwMCwKCQkJJ2FsdGVyX2VuZ2luZScgCQk9PiBmYWxzZSwKCQkJJ2FsdGVyX2NvbGxhdGlvbicgCT0+IGZhbHNlLAoJCQkndmVyYm9zZScJCQk9PiBmYWxzZQoJCSksICRhcmdzICk7CgoJCS8vIGhhbmRsZSBleGNlcHRpb25zCgkJc2V0X2V4Y2VwdGlvbl9oYW5kbGVyKCBhcnJheSggJHRoaXMsICdleGNlcHRpb25zJyApICk7CgoJCS8vIGhhbmRsZSBlcnJvcnMKCQlzZXRfZXJyb3JfaGFuZGxlciggYXJyYXkoICR0aGlzLCAnZXJyb3JzJyApLCBFX0VSUk9SIHwgRV9XQVJOSU5HICk7CgoJCS8vIGFsbG93IGEgc3RyaW5nIGZvciBjb2x1bW5zCgkJZm9yZWFjaCggYXJyYXkoICdleGNsdWRlX2NvbHMnLCAnaW5jbHVkZV9jb2xzJywgJ3RhYmxlcycgKSBhcyAkbWF5YmVfc3RyaW5nX2FyZyApIHsKCQkJaWYgKCBpc19zdHJpbmcoICRhcmdzWyAkbWF5YmVfc3RyaW5nX2FyZyBdICkgKQoJCQkJJGFyZ3NbICRtYXliZV9zdHJpbmdfYXJnIF0gPSBhcnJheV9maWx0ZXIoIGFycmF5X21hcCggJ3RyaW0nLCBleHBsb2RlKCAnLCcsICRhcmdzWyAkbWF5YmVfc3RyaW5nX2FyZyBdICkgKSApOwoJCX0KCgkJLy8gc2V0IGNsYXNzIHZhcnMKCQlmb3JlYWNoKCAkYXJncyBhcyAkbmFtZSA9PiAkdmFsdWUgKSB7CgkJCWlmICggaXNfc3RyaW5nKCAkdmFsdWUgKSApCgkJCQkkdmFsdWUgPSBzdHJpcGNzbGFzaGVzKCAkdmFsdWUgKTsKCQkJaWYgKCBpc19hcnJheSggJHZhbHVlICkgKQoJCQkJJHZhbHVlID0gYXJyYXlfbWFwKCAnc3RyaXBjc2xhc2hlcycsICR2YWx1ZSApOwoJCQkkdGhpcy0+c2V0KCAkbmFtZSwgJHZhbHVlICk7CgkJfQoKCQkvLyBvbmx5IGZvciBub24gY2xpIGNhbGwsIGNsaSBzZXQgbm8gdGltZW91dCwgbm8gbWVtb3J5IGxpbWl0CgkJaWYoICEgZGVmaW5lZCggJ1NURElOJyApICkgewoKCQkJLy8gaW5jcmVhc2UgdGltZSBvdXQgbGltaXQKCQkJQHNldF90aW1lX2xpbWl0KCA2MCAqIDEwICk7CgoJCQkvLyB0cnkgdG8gcHVzaCB0aGUgYWxsb3dlZCBtZW1vcnkgdXAsIHdoaWxlIHdlJ3JlIGF0IGl0CgkJCUBpbmlfc2V0KCAnbWVtb3J5X2xpbWl0JywgJzEwMjRNJyApOwoKCQl9CgoJCS8vIHNldCB1cCBkYiBjb25uZWN0aW9uCgkJJHRoaXMtPmRiX3NldHVwKCk7CgoJCWlmICggJHRoaXMtPmRiX3ZhbGlkKCkgKSB7CgoJCQkvLyB1cGRhdGUgZW5naW5lcwoJCQlpZiAoICR0aGlzLT5hbHRlcl9lbmdpbmUgKSB7CgkJCQkkcmVwb3J0ID0gJHRoaXMtPnVwZGF0ZV9lbmdpbmUoICR0aGlzLT5hbHRlcl9lbmdpbmUsICR0aGlzLT50YWJsZXMgKTsKCQkJfQoKCQkJLy8gdXBkYXRlIGNvbGxhdGlvbgoJCQllbHNlaWYgKCAkdGhpcy0+YWx0ZXJfY29sbGF0aW9uICkgewoJCQkJJHJlcG9ydCA9ICR0aGlzLT51cGRhdGVfY29sbGF0aW9uKCAkdGhpcy0+YWx0ZXJfY29sbGF0aW9uLCAkdGhpcy0+dGFibGVzICk7CgkJCX0KCgkJCS8vIGRlZmF1bHQgc2VhcmNoL3JlcGxhY2UgYWN0aW9uCgkJCWVsc2UgewoJCQkJJHJlcG9ydCA9ICR0aGlzLT5yZXBsYWNlciggJHRoaXMtPnNlYXJjaCwgJHRoaXMtPnJlcGxhY2UsICR0aGlzLT50YWJsZXMgKTsKCQkJfQoKCQl9IGVsc2UgewoKCQkJJHJlcG9ydCA9ICR0aGlzLT5yZXBvcnQ7CgoJCX0KCgkJLy8gc3RvcmUgcmVwb3J0CgkJJHRoaXMtPnNldCggJ3JlcG9ydCcsICRyZXBvcnQgKTsKCQlyZXR1cm4gJHJlcG9ydDsKCX0KCgoJLyoqCgkgKiBUZXJtaW5hdGVzIGRiIGNvbm5lY3Rpb24KCSAqCgkgKiBAcmV0dXJuIHZvaWQKCSAqLwoJcHVibGljIGZ1bmN0aW9uIF9fZGVzdHJ1Y3QoKSB7CgkJaWYgKCAkdGhpcy0+ZGJfdmFsaWQoKSApCgkJCSR0aGlzLT5kYl9jbG9zZSgpOwoJfQoKCglwdWJsaWMgZnVuY3Rpb24gZ2V0KCAkcHJvcGVydHkgKSB7CgkJcmV0dXJuICR0aGlzLT4kcHJvcGVydHk7Cgl9CgoJcHVibGljIGZ1bmN0aW9uIHNldCggJHByb3BlcnR5LCAkdmFsdWUgKSB7CgkJJHRoaXMtPiRwcm9wZXJ0eSA9ICR2YWx1ZTsKCX0KCgoJcHVibGljIGZ1bmN0aW9uIGV4Y2VwdGlvbnMoICRleGNlcHRpb24gKSB7CgkJZWNobyAkZXhjZXB0aW9uLT5nZXRNZXNzYWdlKCkgLiAiXG4iOwoJfQoKCglwdWJsaWMgZnVuY3Rpb24gZXJyb3JzKCAkbm8sICRtZXNzYWdlLCAkZmlsZSwgJGxpbmUgKSB7CgkJZWNobyAkbWVzc2FnZSAuICJcbiI7Cgl9CgoKCXB1YmxpYyBmdW5jdGlvbiBsb2coICR0eXBlID0gJycgKSB7CgkJJGFyZ3MgPSBhcnJheV9zbGljZSggZnVuY19nZXRfYXJncygpLCAxICk7CgkJaWYgKCAkdGhpcy0+Z2V0KCAndmVyYm9zZScgKSApIHsKCQkJZWNobyAieyR0eXBlfTogIjsKCQkJcHJpbnRfciggJGFyZ3MgKTsKCQkJZWNobyAiXG4iOwoJCX0KCQlyZXR1cm4gJGFyZ3M7Cgl9CgoKCXB1YmxpYyBmdW5jdGlvbiBhZGRfZXJyb3IoICRlcnJvciwgJHR5cGUgPSBudWxsICkgewoJCWlmICggJHR5cGUgIT09IG51bGwgKQoJCQkkdGhpcy0+ZXJyb3JfdHlwZSA9ICR0eXBlOwoJCSR0aGlzLT5lcnJvcnNbICR0aGlzLT5lcnJvcl90eXBlIF1bXSA9ICRlcnJvcjsKCQkkdGhpcy0+bG9nKCAnZXJyb3InLCAkdGhpcy0+ZXJyb3JfdHlwZSwgJGVycm9yICk7Cgl9CgoKCXB1YmxpYyBmdW5jdGlvbiB1c2VfcGRvKCkgewoJCXJldHVybiAkdGhpcy0+Z2V0KCAndXNlX3BkbycgKTsKCX0KCgoJLyoqCgkgKiBTZXR1cCBjb25uZWN0aW9uLCBwb3B1bGF0ZSB0YWJsZXMgYXJyYXkKCSAqCgkgKiBAcmV0dXJuIHZvaWQKCSAqLwoJcHVibGljIGZ1bmN0aW9uIGRiX3NldHVwKCkgewoKCQkkY29ubmVjdGlvbl90eXBlID0gY2xhc3NfZXhpc3RzKCAnUERPJyApID8gJ3BkbycgOiAnbXlzcWwnOwoKCQkvLyBjb25uZWN0CgkJJHRoaXMtPnNldCggJ2RiJywgJHRoaXMtPmNvbm5lY3QoICRjb25uZWN0aW9uX3R5cGUgKSApOwoKCX0KCgoJLyoqCgkgKiBEYXRhYmFzZSBjb25uZWN0aW9uIHR5cGUgcm91dGVyCgkgKgoJICogQHBhcmFtIHN0cmluZyAkdHlwZQoJICoKCSAqIEByZXR1cm4gY2FsbGJhY2sKCSAqLwoJcHVibGljIGZ1bmN0aW9uIGNvbm5lY3QoICR0eXBlID0gJycgKSB7CgkJJG1ldGhvZCA9ICJjb25uZWN0X3skdHlwZX0iOwoJCXJldHVybiAkdGhpcy0+JG1ldGhvZCgpOwoJfQoKCgkvKioKCSAqIENyZWF0ZXMgdGhlIGRhdGFiYXNlIGNvbm5lY3Rpb24gdXNpbmcgb2xkIG15c3FsIGZ1bmN0aW9ucwoJICoKCSAqIEByZXR1cm4gcmVzb3VyY2V8Ym9vbAoJICovCglwdWJsaWMgZnVuY3Rpb24gY29ubmVjdF9teXNxbCgpIHsKCgkJLy8gc3dpdGNoIG9mZiBQRE8KCQkkdGhpcy0+c2V0KCAndXNlX3BkbycsIGZhbHNlICk7CgoJCSRjb25uZWN0aW9uID0gQG15c3FsX2Nvbm5lY3QoICR0aGlzLT5ob3N0LCAkdGhpcy0+dXNlciwgJHRoaXMtPnBhc3MgKTsKCgkJLy8gdW5zZXQgaWYgbm90IGF2YWlsYWJsZQoJCWlmICggISAkY29ubmVjdGlvbiApIHsKCQkJJGNvbm5lY3Rpb24gPSBmYWxzZTsKCQkJJHRoaXMtPmFkZF9lcnJvciggbXlzcWxfZXJyb3IoKSwgJ2RiJyApOwoJCX0KCgkJLy8gc2VsZWN0IHRoZSBkYXRhYmFzZSBmb3Igbm9uIFBETwoJCWlmICggJGNvbm5lY3Rpb24gJiYgISBteXNxbF9zZWxlY3RfZGIoICR0aGlzLT5uYW1lLCAkY29ubmVjdGlvbiApICkgewoJCQkkY29ubmVjdGlvbiA9IGZhbHNlOwoJCQkkdGhpcy0+YWRkX2Vycm9yKCBteXNxbF9lcnJvcigpLCAnZGInICk7CgkJfQoKCQlyZXR1cm4gJGNvbm5lY3Rpb247Cgl9CgoKCS8qKgoJICogU2V0cyB1cCBkYXRhYmFzZSBjb25uZWN0aW9uIHVzaW5nIFBETwoJICoKCSAqIEByZXR1cm4gUERPfGJvb2wKCSAqLwoJcHVibGljIGZ1bmN0aW9uIGNvbm5lY3RfcGRvKCkgewoKCQl0cnkgewoJCQkkY29ubmVjdGlvbiA9IG5ldyBQRE8oICJteXNxbDpob3N0PXskdGhpcy0+aG9zdH07ZGJuYW1lPXskdGhpcy0+bmFtZX0iLCAkdGhpcy0+dXNlciwgJHRoaXMtPnBhc3MgKTsKCQl9IGNhdGNoKCBQRE9FeGNlcHRpb24gJGUgKSB7CgkJCSR0aGlzLT5hZGRfZXJyb3IoICRlLT5nZXRNZXNzYWdlKCksICdkYicgKTsKCQkJJGNvbm5lY3Rpb24gPSBmYWxzZTsKCQl9CgoJCS8vIGNoZWNrIGlmIHRoZXJlJ3MgYSBwcm9ibGVtIHdpdGggb3VyIGRhdGFiYXNlIGF0IHRoaXMgc3RhZ2UKCQlpZiAoICRjb25uZWN0aW9uICYmICEgJGNvbm5lY3Rpb24tPnF1ZXJ5KCAnU0hPVyBUQUJMRVMnICkgKSB7CgkJCSRlcnJvcl9pbmZvID0gJGNvbm5lY3Rpb24tPmVycm9ySW5mbygpOwoJCQlpZiAoICFlbXB0eSggJGVycm9yX2luZm8gKSAmJiBpc19hcnJheSggJGVycm9yX2luZm8gKSApCgkJCQkkdGhpcy0+YWRkX2Vycm9yKCBhcnJheV9wb3AoICRlcnJvcl9pbmZvICksICdkYicgKTsgLy8gQXJyYXkgcG9wIHdpbGwgb25seSBhY2NlcHQgYSAkdmFyLi4KCQkJJGNvbm5lY3Rpb24gPSBmYWxzZTsKCQl9CgoJCXJldHVybiAkY29ubmVjdGlvbjsKCX0KCgoJLyoqCgkgKiBSZXRyaWV2ZSBhbGwgdGFibGVzIGZyb20gdGhlIGRhdGFiYXNlCgkgKgoJICogQHJldHVybiBhcnJheQoJICovCglwdWJsaWMgZnVuY3Rpb24gZ2V0X3RhYmxlcygpIHsKCQkvLyBnZXQgdGFibGVzCgoJCS8vIEEgY2xvbmUgb2Ygc2hvdyB0YWJsZSBzdGF0dXMgYnV0IHdpdGggY2hhcmFjdGVyIHNldCBmb3IgdGhlIHRhYmxlLgoJCSRzaG93X3RhYmxlX3N0YXR1cyA9ICJTRUxFQ1QKCQkgIHQuYFRBQkxFX05BTUVgIGFzIE5hbWUsCgkJICB0LmBFTkdJTkVgIGFzIGBFbmdpbmVgLAoJCSAgdC5gdmVyc2lvbmAgYXMgYFZlcnNpb25gLAoJCSAgdC5gUk9XX0ZPUk1BVGAgQVMgYFJvd19mb3JtYXRgLAoJCSAgdC5gVEFCTEVfUk9XU2AgQVMgYFJvd3NgLAoJCSAgdC5gQVZHX1JPV19MRU5HVEhgIEFTIGBBdmdfcm93X2xlbmd0aGAsCgkJICB0LmBEQVRBX0xFTkdUSGAgQVMgYERhdGFfbGVuZ3RoYCwKCQkgIHQuYE1BWF9EQVRBX0xFTkdUSGAgQVMgYE1heF9kYXRhX2xlbmd0aGAsCgkJICB0LmBJTkRFWF9MRU5HVEhgIEFTIGBJbmRleF9sZW5ndGhgLAoJCSAgdC5gREFUQV9GUkVFYCBBUyBgRGF0YV9mcmVlYCwKCQkgIHQuYEFVVE9fSU5DUkVNRU5UYCBhcyBgQXV0b19pbmNyZW1lbnRgLAoJCSAgdC5gQ1JFQVRFX1RJTUVgIEFTIGBDcmVhdGVfdGltZWAsCgkJICB0LmBVUERBVEVfVElNRWAgQVMgYFVwZGF0ZV90aW1lYCwKCQkgIHQuYENIRUNLX1RJTUVgIEFTIGBDaGVja190aW1lYCwKCQkgIHQuYFRBQkxFX0NPTExBVElPTmAgYXMgQ29sbGF0aW9uLAoJCSAgYy5gQ0hBUkFDVEVSX1NFVF9OQU1FYCBhcyBDaGFyYWN0ZXJfc2V0LAoJCSAgdC5gQ2hlY2tzdW1gLAoJCSAgdC5gQ3JlYXRlX29wdGlvbnNgLAoJCSAgdC5gdGFibGVfQ29tbWVudGAgYXMgYENvbW1lbnRgCgkJRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEuYFRBQkxFU2AgdAoJCQlMRUZUIEpPSU4gaW5mb3JtYXRpb25fc2NoZW1hLmBDT0xMQVRJT05fQ0hBUkFDVEVSX1NFVF9BUFBMSUNBQklMSVRZYCBjCgkJCQlPTiAoIHQuYFRBQkxFX0NPTExBVElPTmAgPSBjLmBDT0xMQVRJT05fTkFNRWAgKQoJCSAgV0hFUkUgdC5gVEFCTEVfU0NIRU1BYCA9ICd7JHRoaXMtPm5hbWV9JzsKCQkiOwoKCQkkYWxsX3RhYmxlc19teXNxbCA9ICR0aGlzLT5kYl9xdWVyeSggJHNob3dfdGFibGVfc3RhdHVzICk7CgkJJGFsbF90YWJsZXMgPSBhcnJheSgpOwoKCQlpZiAoICEgJGFsbF90YWJsZXNfbXlzcWwgKSB7CgoJCQkkdGhpcy0+YWRkX2Vycm9yKCAkdGhpcy0+ZGJfZXJyb3IoICksICdkYicgKTsKCgkJfSBlbHNlIHsKCgkJCS8vIHNldCB0aGUgY2hhcmFjdGVyIHNldAoJCQkvLyR0aGlzLT5kYl9zZXRfY2hhcnNldCggJHRoaXMtPmdldCggJ2NoYXJzZXQnICkgKTsKCgkJCXdoaWxlICggJHRhYmxlID0gJHRoaXMtPmRiX2ZldGNoKCAkYWxsX3RhYmxlc19teXNxbCApICkgewoJCQkJLy8gaWdub3JlIHZpZXdzCgkJCQlpZiAoICR0YWJsZVsgJ0NvbW1lbnQnIF0gPT0gJ1ZJRVcnICkKCQkJCQljb250aW51ZTsKCgkJCQkkYWxsX3RhYmxlc1sgJHRhYmxlWzBdIF0gPSAkdGFibGU7CgkJCX0KCgkJfQoKCQlyZXR1cm4gJGFsbF90YWJsZXM7Cgl9CgoKCS8qKgoJICogR2V0IHRoZSBjaGFyYWN0ZXIgc2V0IGZvciB0aGUgY3VycmVudCB0YWJsZQoJICoKCSAqIEBwYXJhbSBzdHJpbmcgJHRhYmxlX25hbWUgVGhlIG5hbWUgb2YgdGhlIHRhYmxlIHdlIHdhbnQgdG8gZ2V0IHRoZSBjaGFyCgkgKiBzZXQgZm9yCgkgKgoJICogQHJldHVybiBzdHJpbmcgICAgVGhlIGNoYXJhY3RlciBlbmNvZGluZzsKCSAqLwoJcHVibGljIGZ1bmN0aW9uIGdldF90YWJsZV9jaGFyYWN0ZXJfc2V0KCAkdGFibGVfbmFtZSA9ICcnICkgewoJCSR0YWJsZV9uYW1lID0gJHRoaXMtPmRiX2VzY2FwZSggJHRhYmxlX25hbWUgKTsKCQkkc2NoZW1hID0gJHRoaXMtPmRiX2VzY2FwZSggJHRoaXMtPm5hbWUgKTsKCgkJJGNoYXJzZXQgPSAkdGhpcy0+ZGJfcXVlcnkoICAiU0VMRUNUIGMuYGNoYXJhY3Rlcl9zZXRfbmFtZWAKCQkJRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEuYFRBQkxFU2AgdAoJCQkJTEVGVCBKT0lOIGluZm9ybWF0aW9uX3NjaGVtYS5gQ09MTEFUSU9OX0NIQVJBQ1RFUl9TRVRfQVBQTElDQUJJTElUWWAgYwoJCQkJT04gKHQuYFRBQkxFX0NPTExBVElPTmAgPSBjLmBDT0xMQVRJT05fTkFNRWApCgkJCVdIRVJFIHQudGFibGVfc2NoZW1hID0geyRzY2hlbWF9CgkJCQlBTkQgdC50YWJsZV9uYW1lID0geyR0YWJsZV9uYW1lfQoJCQlMSU1JVCAxOyIgKTsKCgkJJGVuY29kaW5nID0gZmFsc2U7CgkJaWYgKCAhICRjaGFyc2V0ICkgewoJCQkkdGhpcy0+YWRkX2Vycm9yKCAkdGhpcy0+ZGJfZXJyb3IoICksICdkYicgKTsKCQl9CgkJZWxzZSB7CgkJCSRyZXN1bHQgPSAkdGhpcy0+ZGJfZmV0Y2goICRjaGFyc2V0ICk7CgkJCSRlbmNvZGluZyA9IGlzc2V0KCAkcmVzdWx0WyAnY2hhcmFjdGVyX3NldF9uYW1lJyBdICkgPyAkcmVzdWx0WyAnY2hhcmFjdGVyX3NldF9uYW1lJyBdIDogZmFsc2U7CgkJfQoKCQlyZXR1cm4gJGVuY29kaW5nOwoJfQoKCgkvKioKCSAqIFJldHJpZXZlIGFsbCBzdXBwb3J0ZWQgZGF0YWJhc2UgZW5naW5lcwoJICoKCSAqIEByZXR1cm4gYXJyYXkKCSAqLwoJcHVibGljIGZ1bmN0aW9uIGdldF9lbmdpbmVzKCkgewoKCQkvLyBnZXQgYXZhaWxhYmxlIGVuZ2luZXMKCQkkbXlzcWxfZW5naW5lcyA9ICR0aGlzLT5kYl9xdWVyeSggJ1NIT1cgRU5HSU5FUzsnICk7CgkJJGVuZ2luZXMgPSBhcnJheSgpOwoKCQlpZiAoICEgJG15c3FsX2VuZ2luZXMgKSB7CgkJCSR0aGlzLT5hZGRfZXJyb3IoICR0aGlzLT5kYl9lcnJvciggKSwgJ2RiJyApOwoJCX0gZWxzZSB7CgkJCXdoaWxlICggJGVuZ2luZSA9ICR0aGlzLT5kYl9mZXRjaCggJG15c3FsX2VuZ2luZXMgKSApIHsKCQkJCWlmICggaW5fYXJyYXkoICRlbmdpbmVbICdTdXBwb3J0JyBdLCBhcnJheSggJ1lFUycsICdERUZBVUxUJyApICkgKQoJCQkJCSRlbmdpbmVzW10gPSAkZW5naW5lWyAnRW5naW5lJyBdOwoJCQl9CgkJfQoKCQlyZXR1cm4gJGVuZ2luZXM7Cgl9CgoKCXB1YmxpYyBmdW5jdGlvbiBkYl9xdWVyeSggJHF1ZXJ5ICkgewoJCWlmICggJHRoaXMtPnVzZV9wZG8oKSApCgkJCXJldHVybiAkdGhpcy0+ZGItPnF1ZXJ5KCAkcXVlcnkgKTsKCQllbHNlCgkJCXJldHVybiBteXNxbF9xdWVyeSggJHF1ZXJ5LCAkdGhpcy0+ZGIgKTsKCX0KCglwdWJsaWMgZnVuY3Rpb24gZGJfdXBkYXRlKCAkcXVlcnkgKSB7CgkJaWYgKCAkdGhpcy0+dXNlX3BkbygpICkKCQkJcmV0dXJuICR0aGlzLT5kYi0+ZXhlYyggJHF1ZXJ5ICk7CgkJZWxzZQoJCQlyZXR1cm4gbXlzcWxfcXVlcnkoICRxdWVyeSwgJHRoaXMtPmRiICk7Cgl9CgoJcHVibGljIGZ1bmN0aW9uIGRiX2Vycm9yKCkgewoJCWlmICggJHRoaXMtPnVzZV9wZG8oKSApIHsKCQkJJGVycm9yX2luZm8gPSAkdGhpcy0+ZGItPmVycm9ySW5mbygpOwoJCQlyZXR1cm4gIWVtcHR5KCAkZXJyb3JfaW5mbyApICYmIGlzX2FycmF5KCAkZXJyb3JfaW5mbyApID8gYXJyYXlfcG9wKCAkZXJyb3JfaW5mbyApIDogJ1Vua25vd24gZXJyb3InOwoJCX0KCQllbHNlCgkJCXJldHVybiBteXNxbF9lcnJvcigpOwoJfQoKCXB1YmxpYyBmdW5jdGlvbiBkYl9mZXRjaCggJGRhdGEgKSB7CgkJaWYgKCAkdGhpcy0+dXNlX3BkbygpICkKCQkJcmV0dXJuICRkYXRhLT5mZXRjaCgpOwoJCWVsc2UKCQkJcmV0dXJuIG15c3FsX2ZldGNoX2FycmF5KCAkZGF0YSApOwoJfQoKCXB1YmxpYyBmdW5jdGlvbiBkYl9lc2NhcGUoICRzdHJpbmcgKSB7CgkJaWYgKCAkdGhpcy0+dXNlX3BkbygpICkKCQkJcmV0dXJuICR0aGlzLT5kYi0+cXVvdGUoICRzdHJpbmcgKTsKCQllbHNlCgkJCXJldHVybiAiJyIgLiBteXNxbF9yZWFsX2VzY2FwZV9zdHJpbmcoICRzdHJpbmcgKSAuICInIjsKCX0KCglwdWJsaWMgZnVuY3Rpb24gZGJfZnJlZV9yZXN1bHQoICRkYXRhICkgewoJCWlmICggJHRoaXMtPnVzZV9wZG8oKSApCgkJCXJldHVybiAkZGF0YS0+Y2xvc2VDdXJzb3IoKTsKCQllbHNlCgkJCXJldHVybiBteXNxbF9mcmVlX3Jlc3VsdCggJGRhdGEgKTsKCX0KCglwdWJsaWMgZnVuY3Rpb24gZGJfc2V0X2NoYXJzZXQoICRjaGFyc2V0ID0gJycgKSB7CgkJaWYgKCAhIGVtcHR5KCAkY2hhcnNldCApICkgewoJCQlpZiAoICEgJHRoaXMtPnVzZV9wZG8oKSAmJiBmdW5jdGlvbl9leGlzdHMoICdteXNxbF9zZXRfY2hhcnNldCcgKSApCgkJCQlteXNxbF9zZXRfY2hhcnNldCggJGNoYXJzZXQsICR0aGlzLT5kYiApOwoJCQllbHNlCgkJCQkkdGhpcy0+ZGJfcXVlcnkoICdTRVQgTkFNRVMgJyAuICRjaGFyc2V0ICk7CgkJfQoJfQoKCXB1YmxpYyBmdW5jdGlvbiBkYl9jbG9zZSgpIHsKCQlpZiAoICR0aGlzLT51c2VfcGRvKCkgKQoJCQl1bnNldCggJHRoaXMtPmRiICk7CgkJZWxzZQoJCQlteXNxbF9jbG9zZSggJHRoaXMtPmRiICk7Cgl9CgoJcHVibGljIGZ1bmN0aW9uIGRiX3ZhbGlkKCkgewoJCXJldHVybiAoYm9vbCkkdGhpcy0+ZGI7Cgl9CgoKCS8qKgoJICogV2FsayBhbiBhcnJheSByZXBsYWNpbmcgb25lIGVsZW1lbnQgZm9yIGFub3RoZXIuICggTk9UIFVTRUQgQU5ZIE1PUkUgKQoJICoKCSAqIEBwYXJhbSBzdHJpbmcgJGZpbmQgICAgVGhlIHN0cmluZyB3ZSB3YW50IHRvIHJlcGxhY2UuCgkgKiBAcGFyYW0gc3RyaW5nICRyZXBsYWNlIFdoYXQgd2UnbGwgYmUgcmVwbGFjaW5nIGl0IHdpdGguCgkgKiBAcGFyYW0gYXJyYXkgJGRhdGEgICAgVXNlZCB0byBwYXNzIGFueSBzdWJvcmRpbmF0ZSBhcnJheXMgYmFjayB0byB0aGUKCSAqIGZ1bmN0aW9uIGZvciBzZWFyY2hpbmcuCgkgKgoJICogQHJldHVybiBhcnJheSAgICBUaGUgb3JpZ2luYWwgYXJyYXkgd2l0aCB0aGUgcmVwbGFjZW1lbnRzIG1hZGUuCgkgKi8KCXB1YmxpYyBmdW5jdGlvbiByZWN1cnNpdmVfYXJyYXlfcmVwbGFjZSggJGZpbmQsICRyZXBsYWNlLCAkZGF0YSApIHsKCQlpZiAoIGlzX2FycmF5KCAkZGF0YSApICkgewoJCQlmb3JlYWNoICggJGRhdGEgYXMgJGtleSA9PiAkdmFsdWUgKSB7CgkJCQlpZiAoIGlzX2FycmF5KCAkdmFsdWUgKSApIHsKCQkJCQkkdGhpcy0+cmVjdXJzaXZlX2FycmF5X3JlcGxhY2UoICRmaW5kLCAkcmVwbGFjZSwgJGRhdGFbICRrZXkgXSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBoYXZlIHRvIGNoZWNrIGlmIGl0J3Mgc3RyaW5nIHRvIGVuc3VyZSBubyBzd2l0Y2hpbmcgdG8gc3RyaW5nIGZvciBib29sZWFucy9udW1iZXJzL251bGxzIC0gZG9uJ3QgbmVlZCBhbnkgbmFzdHkgY29udmVyc2lvbnMKCQkJCQlpZiAoIGlzX3N0cmluZyggJHZhbHVlICkgKQoJCQkJCQkkZGF0YVsgJGtleSBdID0gJHRoaXMtPnN0cl9yZXBsYWNlKCAkZmluZCwgJHJlcGxhY2UsICR2YWx1ZSApOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCBpc19zdHJpbmcoICRkYXRhICkgKQoJCQkJJGRhdGEgPSAkdGhpcy0+c3RyX3JlcGxhY2UoICRmaW5kLCAkcmVwbGFjZSwgJGRhdGEgKTsKCQl9Cgl9CgoKCS8qKgoJICogVGFrZSBhIHNlcmlhbGlzZWQgYXJyYXkgYW5kIHVuc2VyaWFsaXNlIGl0IHJlcGxhY2luZyBlbGVtZW50cyBhcyBuZWVkZWQgYW5kCgkgKiB1bnNlcmlhbGlzaW5nIGFueSBzdWJvcmRpbmF0ZSBhcnJheXMgYW5kIHBlcmZvcm1pbmcgdGhlIHJlcGxhY2Ugb24gdGhvc2UgdG9vLgoJICoKCSAqIEBwYXJhbSBzdHJpbmcgJGZyb20gICAgICAgU3RyaW5nIHdlJ3JlIGxvb2tpbmcgdG8gcmVwbGFjZS4KCSAqIEBwYXJhbSBzdHJpbmcgJHRvICAgICAgICAgV2hhdCB3ZSB3YW50IGl0IHRvIGJlIHJlcGxhY2VkIHdpdGgKCSAqIEBwYXJhbSBhcnJheSAgJGRhdGEgICAgICAgVXNlZCB0byBwYXNzIGFueSBzdWJvcmRpbmF0ZSBhcnJheXMgYmFjayB0byBpbi4KCSAqIEBwYXJhbSBib29sICAgJHNlcmlhbGlzZWQgRG9lcyB0aGUgYXJyYXkgcGFzc2VkIHZpYSAkZGF0YSBuZWVkIHNlcmlhbGlzaW5nLgoJICoKCSAqIEByZXR1cm4gYXJyYXkJVGhlIG9yaWdpbmFsIGFycmF5IHdpdGggYWxsIGVsZW1lbnRzIHJlcGxhY2VkIGFzIG5lZWRlZC4KCSAqLwoJcHVibGljIGZ1bmN0aW9uIHJlY3Vyc2l2ZV91bnNlcmlhbGl6ZV9yZXBsYWNlKCAkZnJvbSA9ICcnLCAkdG8gPSAnJywgJGRhdGEgPSAnJywgJHNlcmlhbGlzZWQgPSBmYWxzZSApIHsKCgkJLy8gc29tZSB1bnNlcmlhbGlzZWQgZGF0YSBjYW5ub3QgYmUgcmUtc2VyaWFsaXNlZCBlZy4gU2ltcGxlWE1MRWxlbWVudHMKCQl0cnkgewoKCQkJaWYgKCBpc19zdHJpbmcoICRkYXRhICkgJiYgKCAkdW5zZXJpYWxpemVkID0gQHVuc2VyaWFsaXplKCAkZGF0YSApICkgIT09IGZhbHNlICkgewoJCQkJJGRhdGEgPSAkdGhpcy0+cmVjdXJzaXZlX3Vuc2VyaWFsaXplX3JlcGxhY2UoICRmcm9tLCAkdG8sICR1bnNlcmlhbGl6ZWQsIHRydWUgKTsKCQkJfQoKCQkJZWxzZWlmICggaXNfYXJyYXkoICRkYXRhICkgKSB7CgkJCQkkX3RtcCA9IGFycmF5KCApOwoJCQkJZm9yZWFjaCAoICRkYXRhIGFzICRrZXkgPT4gJHZhbHVlICkgewoJCQkJCSRfdG1wWyAka2V5IF0gPSAkdGhpcy0+cmVjdXJzaXZlX3Vuc2VyaWFsaXplX3JlcGxhY2UoICRmcm9tLCAkdG8sICR2YWx1ZSwgZmFsc2UgKTsKCQkJCX0KCgkJCQkkZGF0YSA9ICRfdG1wOwoJCQkJdW5zZXQoICRfdG1wICk7CgkJCX0KCgkJCS8vIFN1Ym1pdHRlZCBieSBUaW5hIE1hdHRlcgoJCQllbHNlaWYgKCBpc19vYmplY3QoICRkYXRhICkgKSB7CgkJCQkvLyAkZGF0YV9jbGFzcyA9IGdldF9jbGFzcyggJGRhdGEgKTsKCQkJCSRfdG1wID0gJGRhdGE7IC8vIG5ldyAkZGF0YV9jbGFzcyggKTsKCQkJCSRwcm9wcyA9IGdldF9vYmplY3RfdmFycyggJGRhdGEgKTsKCQkJCWZvcmVhY2ggKCAkcHJvcHMgYXMgJGtleSA9PiAkdmFsdWUgKSB7CgkJCQkJJF90bXAtPiRrZXkgPSAkdGhpcy0+cmVjdXJzaXZlX3Vuc2VyaWFsaXplX3JlcGxhY2UoICRmcm9tLCAkdG8sICR2YWx1ZSwgZmFsc2UgKTsKCQkJCX0KCgkJCQkkZGF0YSA9ICRfdG1wOwoJCQkJdW5zZXQoICRfdG1wICk7CgkJCX0KCgkJCWVsc2UgewoJCQkJaWYgKCBpc19zdHJpbmcoICRkYXRhICkgKSB7CgkJCQkJJGRhdGEgPSAkdGhpcy0+c3RyX3JlcGxhY2UoICRmcm9tLCAkdG8sICRkYXRhICk7CgoJCQkJfQoJCQl9CgoJCQlpZiAoICRzZXJpYWxpc2VkICkKCQkJCXJldHVybiBzZXJpYWxpemUoICRkYXRhICk7CgoJCX0gY2F0Y2goIEV4Y2VwdGlvbiAkZXJyb3IgKSB7CgoJCQkkdGhpcy0+YWRkX2Vycm9yKCAkZXJyb3ItPmdldE1lc3NhZ2UoKSwgJ3Jlc3VsdHMnICk7CgoJCX0KCgkJcmV0dXJuICRkYXRhOwoJfQoKCgkvKioKCSAqIFJlZ3VsYXIgZXhwcmVzc2lvbiBjYWxsYmFjayB0byBmaXggc2VyaWFsaXNlZCBzdHJpbmcgbGVuZ3RocwoJICoKCSAqIEBwYXJhbSBhcnJheSAkbWF0Y2hlcyBtYXRjaGVzIGZyb20gdGhlIHJlZ3VsYXIgZXhwcmVzc2lvbgoJICoKCSAqIEByZXR1cm4gc3RyaW5nCgkgKi8KCXB1YmxpYyBmdW5jdGlvbiBwcmVnX2ZpeF9zZXJpYWxpc2VkX2NvdW50KCAkbWF0Y2hlcyApIHsKCQkkbGVuZ3RoID0gbWJfc3RybGVuKCAkbWF0Y2hlc1sgMiBdICk7CgkJaWYgKCAkbGVuZ3RoICE9PSBpbnR2YWwoICRtYXRjaGVzWyAxIF0gKSApCgkJCXJldHVybiAiczp7JGxlbmd0aH06XCJ7JG1hdGNoZXNbMl19XCI7IjsKCQlyZXR1cm4gJG1hdGNoZXNbIDAgXTsKCX0KCgoJLyoqCgkgKiBUaGUgbWFpbiBsb29wIHRyaWdnZXJlZCBpbiBzdGVwIDUuIFVwIGhlcmUgdG8ga2VlcCBpdCBvdXQgb2YgdGhlIHdheSBvZiB0aGUKCSAqIEhUTUwuIFRoaXMgd2Fsa3MgZXZlcnkgdGFibGUgaW4gdGhlIGRiIHRoYXQgd2FzIHNlbGVjdGVkIGluIHN0ZXAgMyBhbmQgdGhlbgoJICogd2Fsa3MgZXZlcnkgcm93IGFuZCBjb2x1bW4gcmVwbGFjaW5nIGFsbCBvY2N1cmVuY2VzIG9mIGEgc3RyaW5nIHdpdGggYW5vdGhlci4KCSAqIFdlIHNwbGl0IGxhcmdlIHRhYmxlcyBpbnRvIDUwLDAwMCByb3cgYmxvY2tzIHdoZW4gZGVhbGluZyB3aXRoIHRoZW0gdG8gc2F2ZQoJICogb24gbWVtbW9yeSBjb25zdW1wdGlvbi4KCSAqCgkgKiBAcGFyYW0gc3RyaW5nICRzZWFyY2ggICAgIFdoYXQgd2Ugd2FudCB0byByZXBsYWNlCgkgKiBAcGFyYW0gc3RyaW5nICRyZXBsYWNlICAgIFdoYXQgd2Ugd2FudCB0byByZXBsYWNlIGl0IHdpdGguCgkgKiBAcGFyYW0gYXJyYXkgICR0YWJsZXMgICAgIFRoZSB0YWJsZXMgd2Ugd2FudCB0byBsb29rIGF0LgoJICoKCSAqIEByZXR1cm4gYXJyYXkgICAgQ29sbGVjdGlvbiBvZiBpbmZvcm1hdGlvbiBnYXRoZXJlZCBkdXJpbmcgdGhlIHJ1bi4KCSAqLwoJcHVibGljIGZ1bmN0aW9uIHJlcGxhY2VyKCAkc2VhcmNoID0gJycsICRyZXBsYWNlID0gJycsICR0YWJsZXMgPSBhcnJheSggKSApIHsKCgkJLy8gY2hlY2sgd2UgaGF2ZSBhIHNlYXJjaCBzdHJpbmcsIGJhaWwgaWYgbm90CgkJaWYgKCBlbXB0eSggJHNlYXJjaCApICkgewoJCQkkdGhpcy0+YWRkX2Vycm9yKCAnU2VhcmNoIHN0cmluZyBpcyBlbXB0eScsICdzZWFyY2gnICk7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCSRyZXBvcnQgPSBhcnJheSggJ3RhYmxlcycgPT4gMCwKCQkgICAgICAgICAgICAgICAgICdyb3dzJyA9PiAwLAoJCSAgICAgICAgICAgICAgICAgJ2NoYW5nZScgPT4gMCwKCQkgICAgICAgICAgICAgICAgICd1cGRhdGVzJyA9PiAwLAoJCSAgICAgICAgICAgICAgICAgJ3N0YXJ0JyA9PiBtaWNyb3RpbWUoICksCgkJICAgICAgICAgICAgICAgICAnZW5kJyA9PiBtaWNyb3RpbWUoICksCgkJICAgICAgICAgICAgICAgICAnZXJyb3JzJyA9PiBhcnJheSggKSwKCQkgICAgICAgICAgICAgICAgICd0YWJsZV9yZXBvcnRzJyA9PiBhcnJheSggKQoJCSk7CgoJCSR0YWJsZV9yZXBvcnQgPSBhcnJheSgKCQkJJ3Jvd3MnID0+IDAsCgkJCSdjaGFuZ2UnID0+IDAsCgkJCSdjaGFuZ2VzJyA9PiBhcnJheSggKSwKCQkJJ3VwZGF0ZXMnID0+IDAsCgkJCSdzdGFydCcgPT4gbWljcm90aW1lKCApLAoJCQknZW5kJyA9PiBtaWNyb3RpbWUoICksCgkJCSdlcnJvcnMnID0+IGFycmF5KCApLAoJCSk7CgoJCSRkcnlfcnVuID0gJHRoaXMtPmdldCggJ2RyeV9ydW4nICk7CgoJCWlmICggJHRoaXMtPmdldCggJ2RyeV9ydW4nICkgKSAJLy8gUmVwb3J0IHRoaXMgYXMgYSBzZWFyY2gtb25seSBydW4uCgkJCSR0aGlzLT5hZGRfZXJyb3IoICdUaGUgZHJ5LXJ1biBvcHRpb24gd2FzIHNlbGVjdGVkLiBObyByZXBsYWNlbWVudHMgd2lsbCBiZSBtYWRlLicsICdyZXN1bHRzJyApOwoKCQkvLyBpZiBubyB0YWJsZXMgc2VsZWN0ZWQgYXNzdW1lIGFsbAoJCWlmICggZW1wdHkoICR0YWJsZXMgKSApIHsKCQkJJGFsbF90YWJsZXMgPSAkdGhpcy0+Z2V0X3RhYmxlcygpOwoJCQkkdGFibGVzID0gYXJyYXlfa2V5cyggJGFsbF90YWJsZXMgKTsKCQl9CgoJCWlmICggaXNfYXJyYXkoICR0YWJsZXMgKSAmJiAhIGVtcHR5KCAkdGFibGVzICkgKSB7CgoJCQlmb3JlYWNoKCAkdGFibGVzIGFzICR0YWJsZSApIHsKCgkJCQkkZW5jb2RpbmcgPSAkdGhpcy0+Z2V0X3RhYmxlX2NoYXJhY3Rlcl9zZXQoICR0YWJsZSApOwoJCQkJc3dpdGNoKCAkZW5jb2RpbmcgKSB7CgoJCQkJCS8vIFRhYmxlcyBlbmNvZGVkIHdpdGggdGhpcyB3b3JrIGZvciBtZSBvbmx5IHdoZW4gSSBzZXQgbmFtZXMgdG8gdXRmOC4gSSBkb24ndCB0cnVzdCB0aGlzIGluIHRoZSB3aWxkIHNvIEknbSBnb2luZyB0byBhdm9pZC4KCQkJCQljYXNlICd1dGYxNic6CgkJCQkJY2FzZSAndXRmMzInOgoJCQkJCQkvLyRlbmNvZGluZyA9ICd1dGY4JzsKCQkJCQkJJHRoaXMtPmFkZF9lcnJvciggIlRoZSB0YWJsZSBcInskdGFibGV9XCIgaXMgZW5jb2RlZCB1c2luZyBcInskZW5jb2Rpbmd9XCIgd2hpY2ggaXMgY3VycmVudGx5IHVuc3VwcG9ydGVkLiIsICdyZXN1bHRzJyApOwoJCQkJCQljb250aW51ZTsKCQkJCQkJYnJlYWs7CgoJCQkJCWRlZmF1bHQ6CgkJCQkJCSR0aGlzLT5kYl9zZXRfY2hhcnNldCggJGVuY29kaW5nICk7CgkJCQkJCWJyZWFrOwoJCQkJfQoKCgkJCQkkcmVwb3J0WyAndGFibGVzJyBdKys7CgoJCQkJLy8gZ2V0IHByaW1hcnkga2V5IGFuZCBjb2x1bW5zCgkJCQlsaXN0KCAkcHJpbWFyeV9rZXksICRjb2x1bW5zICkgPSAkdGhpcy0+Z2V0X2NvbHVtbnMoICR0YWJsZSApOwoKCQkJCWlmICggJHByaW1hcnlfa2V5ID09PSBudWxsICkgewoJCQkJCSR0aGlzLT5hZGRfZXJyb3IoICJUaGUgdGFibGUgXCJ7JHRhYmxlfVwiIGhhcyBubyBwcmltYXJ5IGtleS4gQ2hhbmdlcyB3aWxsIGhhdmUgdG8gYmUgbWFkZSBtYW51YWxseS4iLCAncmVzdWx0cycgKTsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQkvLyBjcmVhdGUgbmV3IHRhYmxlIHJlcG9ydCBpbnN0YW5jZQoJCQkJJG5ld190YWJsZV9yZXBvcnQgPSAkdGFibGVfcmVwb3J0OwoJCQkJJG5ld190YWJsZV9yZXBvcnRbICdzdGFydCcgXSA9IG1pY3JvdGltZSgpOwoKCQkJCSR0aGlzLT5sb2coICdzZWFyY2hfcmVwbGFjZV90YWJsZV9zdGFydCcsICR0YWJsZSwgJHNlYXJjaCwgJHJlcGxhY2UgKTsKCgkJCQkvLyBDb3VudCB0aGUgbnVtYmVyIG9mIHJvd3Mgd2UgaGF2ZSBpbiB0aGUgdGFibGUgaWYgbGFyZ2Ugd2UnbGwgc3BsaXQgaW50byBibG9ja3MsIFRoaXMgaXMgYSBtb2QgZnJvbSBTaW1vbiBXaGVhdGxleQoJCQkJJHJvd19jb3VudCA9ICR0aGlzLT5kYl9xdWVyeSggIlNFTEVDVCBDT1VOVCgqKSBGUk9NIGB7JHRhYmxlfWAiICk7CgkJCQkkcm93c19yZXN1bHQgPSAkdGhpcy0+ZGJfZmV0Y2goICRyb3dfY291bnQgKTsKCQkJCSRyb3dfY291bnQgPSAkcm93c19yZXN1bHRbIDAgXTsKCgkJCQkkcGFnZV9zaXplID0gJHRoaXMtPmdldCggJ3BhZ2Vfc2l6ZScgKTsKCQkJCSRwYWdlcyA9IGNlaWwoICRyb3dfY291bnQgLyAkcGFnZV9zaXplICk7CgoJCQkJZm9yKCAkcGFnZSA9IDA7ICRwYWdlIDwgJHBhZ2VzOyAkcGFnZSsrICkgewoKCQkJCQkkc3RhcnQgPSAkcGFnZSAqICRwYWdlX3NpemU7CgoJCQkJCS8vIEdyYWIgdGhlIGNvbnRlbnQgb2YgdGhlIHRhYmxlCgkJCQkJJGRhdGEgPSAkdGhpcy0+ZGJfcXVlcnkoIHNwcmludGYoICdTRUxFQ1QgKiBGUk9NIGAlc2AgTElNSVQgJWQsICVkJywgJHRhYmxlLCAkc3RhcnQsICRwYWdlX3NpemUgKSApOwoKCQkJCQlpZiAoICEgJGRhdGEgKQoJCQkJCQkkdGhpcy0+YWRkX2Vycm9yKCAkdGhpcy0+ZGJfZXJyb3IoICksICdyZXN1bHRzJyApOwoKCQkJCQl3aGlsZSAoICRyb3cgPSAkdGhpcy0+ZGJfZmV0Y2goICRkYXRhICkgKSB7CgoJCQkJCQkkcmVwb3J0WyAncm93cycgXSsrOyAvLyBJbmNyZW1lbnQgdGhlIHJvdyBjb3VudGVyCgkJCQkJCSRuZXdfdGFibGVfcmVwb3J0WyAncm93cycgXSsrOwoKCQkJCQkJJHVwZGF0ZV9zcWwgPSBhcnJheSggKTsKCQkJCQkJJHdoZXJlX3NxbCA9IGFycmF5KCApOwoJCQkJCQkkdXBkYXRlID0gZmFsc2U7CgoJCQkJCQlmb3JlYWNoKCAkY29sdW1ucyBhcyAkY29sdW1uICkgewoKCQkJCQkJCSRlZGl0ZWRfZGF0YSA9ICRkYXRhX3RvX2ZpeCA9ICRyb3dbICRjb2x1bW4gXTsKCgkJCQkJCQlpZiAoICRwcmltYXJ5X2tleSA9PSAkY29sdW1uICkgewoJCQkJCQkJCSR3aGVyZV9zcWxbXSA9ICJgeyRjb2x1bW59YCA9ICIgLiAkdGhpcy0+ZGJfZXNjYXBlKCAkZGF0YV90b19maXggKTsKCQkJCQkJCQljb250aW51ZTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBleGNsdWRlIGNvbHMKCQkJCQkJCWlmICggaW5fYXJyYXkoICRjb2x1bW4sICR0aGlzLT5leGNsdWRlX2NvbHMgKSApCgkJCQkJCQkJY29udGludWU7CgoJCQkJCQkJLy8gaW5jbHVkZSBjb2xzCgkJCQkJCQlpZiAoICEgZW1wdHkoICR0aGlzLT5pbmNsdWRlX2NvbHMgKSAmJiAhIGluX2FycmF5KCAkY29sdW1uLCAkdGhpcy0+aW5jbHVkZV9jb2xzICkgKQoJCQkJCQkJCWNvbnRpbnVlOwoKCQkJCQkJCS8vIFJ1biBhIHNlYXJjaCByZXBsYWNlIG9uIHRoZSBkYXRhIHRoYXQnbGwgcmVzcGVjdCB0aGUgc2VyaWFsaXNhdGlvbi4KCQkJCQkJCSRlZGl0ZWRfZGF0YSA9ICR0aGlzLT5yZWN1cnNpdmVfdW5zZXJpYWxpemVfcmVwbGFjZSggJHNlYXJjaCwgJHJlcGxhY2UsICRkYXRhX3RvX2ZpeCApOwoKCQkJCQkJCS8vIFNvbWV0aGluZyB3YXMgY2hhbmdlZAoJCQkJCQkJaWYgKCAkZWRpdGVkX2RhdGEgIT0gJGRhdGFfdG9fZml4ICkgewoKCQkJCQkJCQkkcmVwb3J0WyAnY2hhbmdlJyBdKys7CgkJCQkJCQkJJG5ld190YWJsZV9yZXBvcnRbICdjaGFuZ2UnIF0rKzsKCgkJCQkJCQkJLy8gbG9nIGZpcnN0IHggY2hhbmdlcwoJCQkJCQkJCWlmICggJG5ld190YWJsZV9yZXBvcnRbICdjaGFuZ2UnIF0gPD0gJHRoaXMtPmdldCggJ3JlcG9ydF9jaGFuZ2VfbnVtJyApICkgewoJCQkJCQkJCQkkbmV3X3RhYmxlX3JlcG9ydFsgJ2NoYW5nZXMnIF1bXSA9IGFycmF5KAoJCQkJCQkJCQkJJ3JvdycgPT4gJG5ld190YWJsZV9yZXBvcnRbICdyb3dzJyBdLAoJCQkJCQkJCQkJJ2NvbHVtbicgPT4gJGNvbHVtbiwKCQkJCQkJCQkJCSdmcm9tJyA9PiB1dGY4X2VuY29kZSggJGRhdGFfdG9fZml4ICksCgkJCQkJCQkJCQkndG8nID0+IHV0ZjhfZW5jb2RlKCAkZWRpdGVkX2RhdGEgKQoJCQkJCQkJCQkpOwoJCQkJCQkJCX0KCgkJCQkJCQkJJHVwZGF0ZV9zcWxbXSA9ICJgeyRjb2x1bW59YCA9ICIgLiAkdGhpcy0+ZGJfZXNjYXBlKCAkZWRpdGVkX2RhdGEgKTsKCQkJCQkJCQkkdXBkYXRlID0gdHJ1ZTsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCQlpZiAoICRkcnlfcnVuICkgewoJCQkJCQkJLy8gbm90aGluZyBmb3IgdGhpcyBzdGF0ZQoJCQkJCQl9IGVsc2VpZiAoICR1cGRhdGUgJiYgISBlbXB0eSggJHdoZXJlX3NxbCApICkgewoKCQkJCQkJCSRzcWwgPSAnVVBEQVRFICcgLiAkdGFibGUgLiAnIFNFVCAnIC4gaW1wbG9kZSggJywgJywgJHVwZGF0ZV9zcWwgKSAuICcgV0hFUkUgJyAuIGltcGxvZGUoICcgQU5EICcsIGFycmF5X2ZpbHRlciggJHdoZXJlX3NxbCApICk7CgkJCQkJCQkkcmVzdWx0ID0gJHRoaXMtPmRiX3VwZGF0ZSggJHNxbCApOwoKCQkJCQkJCWlmICggISBpc19pbnQoICRyZXN1bHQgKSAmJiAhICRyZXN1bHQgKSB7CgoJCQkJCQkJCSR0aGlzLT5hZGRfZXJyb3IoICR0aGlzLT5kYl9lcnJvciggKSwgJ3Jlc3VsdHMnICk7CgoJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJJHJlcG9ydFsgJ3VwZGF0ZXMnIF0rKzsKCQkJCQkJCQkkbmV3X3RhYmxlX3JlcG9ydFsgJ3VwZGF0ZXMnIF0rKzsKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfQoKCQkJCQkkdGhpcy0+ZGJfZnJlZV9yZXN1bHQoICRkYXRhICk7CgoJCQkJfQoKCQkJCSRuZXdfdGFibGVfcmVwb3J0WyAnZW5kJyBdID0gbWljcm90aW1lKCk7CgoJCQkJLy8gc3RvcmUgdGFibGUgcmVwb3J0IGluIG1haW4KCQkJCSRyZXBvcnRbICd0YWJsZV9yZXBvcnRzJyBdWyAkdGFibGUgXSA9ICRuZXdfdGFibGVfcmVwb3J0OwoKCQkJCS8vIGxvZyByZXN1bHQKCQkJCSR0aGlzLT5sb2coICdzZWFyY2hfcmVwbGFjZV90YWJsZV9lbmQnLCAkdGFibGUsICRuZXdfdGFibGVfcmVwb3J0ICk7CgkJCX0KCgkJfQoKCQkkcmVwb3J0WyAnZW5kJyBdID0gbWljcm90aW1lKCApOwoKCQkkdGhpcy0+bG9nKCAnc2VhcmNoX3JlcGxhY2VfZW5kJywgJHNlYXJjaCwgJHJlcGxhY2UsICRyZXBvcnQgKTsKCgkJcmV0dXJuICRyZXBvcnQ7Cgl9CgoKCXB1YmxpYyBmdW5jdGlvbiBnZXRfY29sdW1ucyggJHRhYmxlICkgewoKCQkkcHJpbWFyeV9rZXkgPSBudWxsOwoJCSRjb2x1bW5zID0gYXJyYXkoICk7CgoJCS8vIEdldCBhIGxpc3Qgb2YgY29sdW1ucyBpbiB0aGlzIHRhYmxlCgkJJGZpZWxkcyA9ICR0aGlzLT5kYl9xdWVyeSggIkRFU0NSSUJFIHskdGFibGV9IiApOwoJCWlmICggISAkZmllbGRzICkgewoJCQkkdGhpcy0+YWRkX2Vycm9yKCAkdGhpcy0+ZGJfZXJyb3IoICksICdkYicgKTsKCQl9IGVsc2UgewoJCQl3aGlsZSggJGNvbHVtbiA9ICR0aGlzLT5kYl9mZXRjaCggJGZpZWxkcyApICkgewoJCQkJJGNvbHVtbnNbXSA9ICRjb2x1bW5bICdGaWVsZCcgXTsKCQkJCWlmICggJGNvbHVtblsgJ0tleScgXSA9PSAnUFJJJyApCgkJCQkJJHByaW1hcnlfa2V5ID0gJGNvbHVtblsgJ0ZpZWxkJyBdOwoJCQl9CgkJfQoKCQlyZXR1cm4gYXJyYXkoICRwcmltYXJ5X2tleSwgJGNvbHVtbnMgKTsKCX0KCgoJcHVibGljIGZ1bmN0aW9uIGRvX2NvbHVtbigpIHsKCgl9CgoKCS8qKgoJICogQ29udmVydCB0YWJsZSBlbmdpbmVzCgkgKgoJICogQHBhcmFtIHN0cmluZyAkZW5naW5lIEVuZ2luZSB0eXBlCgkgKiBAcGFyYW0gYXJyYXkgJHRhYmxlcwoJICoKCSAqIEByZXR1cm4gYXJyYXkgICAgTW9kaWZpY2F0aW9uIHJlcG9ydAoJICovCglwdWJsaWMgZnVuY3Rpb24gdXBkYXRlX2VuZ2luZSggJGVuZ2luZSA9ICdNeUlTQU0nLCAkdGFibGVzID0gYXJyYXkoKSApIHsKCgkJJHJlcG9ydCA9IGZhbHNlOwoKCQlpZiAoIGVtcHR5KCAkdGhpcy0+ZW5naW5lcyApICkKCQkJJHRoaXMtPnNldCggJ2VuZ2luZXMnLCAkdGhpcy0+Z2V0X2VuZ2luZXMoKSApOwoKCQlpZiAoIGluX2FycmF5KCAkZW5naW5lLCAkdGhpcy0+Z2V0KCAnZW5naW5lcycgKSApICkgewoKCQkJJHJlcG9ydCA9IGFycmF5KCAnZW5naW5lJyA9PiAkZW5naW5lLCAnY29udmVydGVkJyA9PiBhcnJheSgpICk7CgoJCQlpZiAoIGVtcHR5KCAkdGFibGVzICkgKSB7CgkJCQkkYWxsX3RhYmxlcyA9ICR0aGlzLT5nZXRfdGFibGVzKCk7CgkJCQkkdGFibGVzID0gYXJyYXlfa2V5cyggJGFsbF90YWJsZXMgKTsKCQkJfQoKCQkJZm9yZWFjaCggJHRhYmxlcyBhcyAkdGFibGUgKSB7CgkJCQkkdGFibGVfaW5mbyA9ICRhbGxfdGFibGVzWyAkdGFibGUgXTsKCgkJCQkvLyBhcmUgd2UgdXBkYXRpbmcgdGhlIGVuZ2luZT8KCQkJCWlmICggJHRhYmxlX2luZm9bICdFbmdpbmUnIF0gIT0gJGVuZ2luZSApIHsKCQkJCQkkZW5naW5lX2NvbnZlcnRlZCA9ICR0aGlzLT5kYl9xdWVyeSggImFsdGVyIHRhYmxlIHskdGFibGV9IGVuZ2luZSA9IHskZW5naW5lfTsiICk7CgkJCQkJaWYgKCAhICRlbmdpbmVfY29udmVydGVkICkKCQkJCQkJJHRoaXMtPmFkZF9lcnJvciggJHRoaXMtPmRiX2Vycm9yKCApLCAncmVzdWx0cycgKTsKCQkJCQllbHNlCgkJCQkJCSRyZXBvcnRbICdjb252ZXJ0ZWQnIF1bICR0YWJsZSBdID0gdHJ1ZTsKCQkJCQljb250aW51ZTsKCQkJCX0gZWxzZSB7CgkJCQkJJHJlcG9ydFsgJ2NvbnZlcnRlZCcgXVsgJHRhYmxlIF0gPSBmYWxzZTsKCQkJCX0KCgkJCQlpZiAoIGlzc2V0KCAkcmVwb3J0WyAnY29udmVydGVkJyBdWyAkdGFibGUgXSApICkKCQkJCQkkdGhpcy0+bG9nKCAndXBkYXRlX2VuZ2luZScsICR0YWJsZSwgJHJlcG9ydCwgJGVuZ2luZSApOwoJCQl9CgoJCX0gZWxzZSB7CgoJCQkkdGhpcy0+YWRkX2Vycm9yKCAnQ2Fubm90IGNvbnZlcnQgdGFibGVzIHRvIHVuc3VwcG9ydGVkIHRhYmxlIGVuZ2luZSAmcmRxdW87JyAuICRlbmdpbmUgLiAnJmxkcXVvOycsICdyZXN1bHRzJyApOwoKCQl9CgoJCXJldHVybiAkcmVwb3J0OwoJfQoKCgkvKioKCSAqIFVwZGF0ZXMgdGhlIGNoYXJhY3RlcnNldCBhbmQgY29sbGF0aW9uIG9uIHRoZSBzcGVjaWZpZWQgdGFibGVzCgkgKgoJICogQHBhcmFtIHN0cmluZyAkY29sbGF0ZSB0YWJsZSBjb2xsYXRpb24KCSAqIEBwYXJhbSBhcnJheSAkdGFibGVzICB0YWJsZXMgdG8gbW9kaWZ5CgkgKgoJICogQHJldHVybiBhcnJheSAgICBNb2RpZmljYXRpb24gcmVwb3J0CgkgKi8KCXB1YmxpYyBmdW5jdGlvbiB1cGRhdGVfY29sbGF0aW9uKCAkY29sbGF0aW9uID0gJ3V0ZjhfdW5pY29kZV9jaScsICR0YWJsZXMgPSBhcnJheSgpICkgewoKCQkkcmVwb3J0ID0gZmFsc2U7CgoJCWlmICggaXNfc3RyaW5nKCAkY29sbGF0aW9uICkgKSB7CgoJCQkkcmVwb3J0ID0gYXJyYXkoICdjb2xsYXRpb24nID0+ICRjb2xsYXRpb24sICdjb252ZXJ0ZWQnID0+IGFycmF5KCkgKTsKCgkJCWlmICggZW1wdHkoICR0YWJsZXMgKSApIHsKCQkJCSRhbGxfdGFibGVzID0gJHRoaXMtPmdldF90YWJsZXMoKTsKCQkJCSR0YWJsZXMgPSBhcnJheV9rZXlzKCAkYWxsX3RhYmxlcyApOwoJCQl9CgoJCQkvLyBjaGFyc2V0IGlzIHNhbWUgYXMgY29sbGF0aW9uIHVwIHRvIGZpcnN0IHVuZGVyc2NvcmUKCQkJJGNoYXJzZXQgPSBwcmVnX3JlcGxhY2UoICcvXihbXl9dKykuKiQvJywgJyQxJywgJGNvbGxhdGlvbiApOwoKCQkJZm9yZWFjaCggJHRhYmxlcyBhcyAkdGFibGUgKSB7CgkJCQkkdGFibGVfaW5mbyA9ICRhbGxfdGFibGVzWyAkdGFibGUgXTsKCgkJCQkvLyBhcmUgd2UgdXBkYXRpbmcgdGhlIGVuZ2luZT8KCQkJCWlmICggJHRhYmxlX2luZm9bICdDb2xsYXRpb24nIF0gIT0gJGNvbGxhdGlvbiApIHsKCQkJCQkkZW5naW5lX2NvbnZlcnRlZCA9ICR0aGlzLT5kYl9xdWVyeSggImFsdGVyIHRhYmxlIHskdGFibGV9IGNvbnZlcnQgdG8gY2hhcmFjdGVyIHNldCB7JGNoYXJzZXR9IGNvbGxhdGUgeyRjb2xsYXRpb259OyIgKTsKCQkJCQlpZiAoICEgJGVuZ2luZV9jb252ZXJ0ZWQgKQoJCQkJCQkkdGhpcy0+YWRkX2Vycm9yKCAkdGhpcy0+ZGJfZXJyb3IoICksICdyZXN1bHRzJyApOwoJCQkJCWVsc2UKCQkJCQkJJHJlcG9ydFsgJ2NvbnZlcnRlZCcgXVsgJHRhYmxlIF0gPSB0cnVlOwoJCQkJCWNvbnRpbnVlOwoJCQkJfSBlbHNlIHsKCQkJCQkkcmVwb3J0WyAnY29udmVydGVkJyBdWyAkdGFibGUgXSA9IGZhbHNlOwoJCQkJfQoKCQkJCWlmICggaXNzZXQoICRyZXBvcnRbICdjb252ZXJ0ZWQnIF1bICR0YWJsZSBdICkgKQoJCQkJCSR0aGlzLT5sb2coICd1cGRhdGVfY29sbGF0aW9uJywgJHRhYmxlLCAkcmVwb3J0LCAkY29sbGF0aW9uICk7CgkJCX0KCgkJfSBlbHNlIHsKCgkJCSR0aGlzLT5hZGRfZXJyb3IoICdDb2xsYXRpb24gbXVzdCBiZSBhIHZhbGlkIHN0cmluZycsICdyZXN1bHRzJyApOwoKCQl9CgoJCXJldHVybiAkcmVwb3J0OwoJfQoKCgkvKioKCSAqIFJlcGxhY2UgYWxsIG9jY3VycmVuY2VzIG9mIHRoZSBzZWFyY2ggc3RyaW5nIHdpdGggdGhlIHJlcGxhY2VtZW50IHN0cmluZy4KCSAqCgkgKiBAYXV0aG9yIFNlYW4gTXVycGh5IDxzZWFuQGlhbXNlYW5tdXJwaHkuY29tPgoJICogQGNvcHlyaWdodCBDb3B5cmlnaHQgMjAxMiBTZWFuIE11cnBoeS4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KCSAqIEBsaWNlbnNlIGh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL3B1YmxpY2RvbWFpbi96ZXJvLzEuMC8KCSAqIEBsaW5rIGh0dHA6Ly9waHAubmV0L21hbnVhbC9mdW5jdGlvbi5zdHItcmVwbGFjZS5waHAKCSAqCgkgKiBAcGFyYW0gbWl4ZWQgJHNlYXJjaAoJICogQHBhcmFtIG1peGVkICRyZXBsYWNlCgkgKiBAcGFyYW0gbWl4ZWQgJHN1YmplY3QKCSAqIEBwYXJhbSBpbnQgJGNvdW50CgkgKiBAcmV0dXJuIG1peGVkCgkgKi8KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gbWJfc3RyX3JlcGxhY2UoICRzZWFyY2gsICRyZXBsYWNlLCAkc3ViamVjdCwgJiRjb3VudCA9IDAgKSB7CgkJaWYgKCAhIGlzX2FycmF5KCAkc3ViamVjdCApICkgewoJCQkvLyBOb3JtYWxpemUgJHNlYXJjaCBhbmQgJHJlcGxhY2Ugc28gdGhleSBhcmUgYm90aCBhcnJheXMgb2YgdGhlIHNhbWUgbGVuZ3RoCgkJCSRzZWFyY2hlcyA9IGlzX2FycmF5KCAkc2VhcmNoICkgPyBhcnJheV92YWx1ZXMoICRzZWFyY2ggKSA6IGFycmF5KCAkc2VhcmNoICk7CgkJCSRyZXBsYWNlbWVudHMgPSBpc19hcnJheSggJHJlcGxhY2UgKSA/IGFycmF5X3ZhbHVlcyggJHJlcGxhY2UgKSA6IGFycmF5KCAkcmVwbGFjZSApOwoJCQkkcmVwbGFjZW1lbnRzID0gYXJyYXlfcGFkKCAkcmVwbGFjZW1lbnRzLCBjb3VudCggJHNlYXJjaGVzICksICcnICk7CgoJCQlmb3JlYWNoICggJHNlYXJjaGVzIGFzICRrZXkgPT4gJHNlYXJjaCApIHsKCQkJCSRwYXJ0cyA9IG1iX3NwbGl0KCBwcmVnX3F1b3RlKCAkc2VhcmNoICksICRzdWJqZWN0ICk7CgkJCQkkY291bnQgKz0gY291bnQoICRwYXJ0cyApIC0gMTsKCQkJCSRzdWJqZWN0ID0gaW1wbG9kZSggJHJlcGxhY2VtZW50c1sgJGtleSBdLCAkcGFydHMgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIENhbGwgbWJfc3RyX3JlcGxhY2UgZm9yIGVhY2ggc3ViamVjdCBpbiBhcnJheSwgcmVjdXJzaXZlbHkKCQkJZm9yZWFjaCAoICRzdWJqZWN0IGFzICRrZXkgPT4gJHZhbHVlICkgewoJCQkJJHN1YmplY3RbICRrZXkgXSA9IHNlbGY6Om1iX3N0cl9yZXBsYWNlKCAkc2VhcmNoLCAkcmVwbGFjZSwgJHZhbHVlLCAkY291bnQgKTsKCQkJfQoJCX0KCgkJcmV0dXJuICRzdWJqZWN0OwoJfQoKCgkvKioKCSAqIFdyYXBwZXIgZm9yIHJlZ2V4L25vbiByZWdleCBzZWFyY2ggJiByZXBsYWNlCgkgKgoJICogQHBhcmFtIHN0cmluZyAkc2VhcmNoCgkgKiBAcGFyYW0gc3RyaW5nICRyZXBsYWNlCgkgKiBAcGFyYW0gc3RyaW5nICRzdHJpbmcKCSAqIEBwYXJhbSBpbnQgJGNvdW50CgkgKgoJICogQHJldHVybiBzdHJpbmcKCSAqLwoJcHVibGljIGZ1bmN0aW9uIHN0cl9yZXBsYWNlKCAkc2VhcmNoLCAkcmVwbGFjZSwgJHN0cmluZywgJiRjb3VudCA9IDAgKSB7CgkJaWYgKCAkdGhpcy0+Z2V0KCAncmVnZXgnICkgKSB7CgkJCXJldHVybiBwcmVnX3JlcGxhY2UoICRzZWFyY2gsICRyZXBsYWNlLCAkc3RyaW5nLCAtMSwgJGNvdW50ICk7CgkJfSBlbHNlaWYoIGZ1bmN0aW9uX2V4aXN0cyggJ21iX3NwbGl0JyApICkgewoJCQlyZXR1cm4gc2VsZjo6bWJfc3RyX3JlcGxhY2UoICRzZWFyY2gsICRyZXBsYWNlLCAkc3RyaW5nLCAkY291bnQgKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gc3RyX3JlcGxhY2UoICRzZWFyY2gsICRyZXBsYWNlLCAkc3RyaW5nLCAkY291bnQgKTsKCQl9Cgl9CgoJLyoqCgkgKiBDb252ZXJ0IGEgc3RyaW5nIGNvbnRhaW5pbmcgdW5pY29kZSBpbnRvIEhUTUwgZW50aXRpZXMgZm9yIGZyb250IGVuZCBkaXNwbGF5CgkgKgoJICogQHBhcmFtIHN0cmluZyAkc3RyaW5nCgkgKgoJICogQHJldHVybiBzdHJpbmcKCSAqLwoJcHVibGljIGZ1bmN0aW9uIGNoYXJzZXRfZGVjb2RlX3V0Zl84KCAkc3RyaW5nICkgewoJCS8qIE9ubHkgZG8gdGhlIHNsb3cgY29udmVydCBpZiB0aGVyZSBhcmUgOC1iaXQgY2hhcmFjdGVycyAqLwoJCS8qIGF2b2lkIHVzaW5nIDB4QTAgKFwyNDApIGluIGVyZWcgcmFuZ2VzLiBSSDczIGRvZXMgbm90IGxpa2UgdGhhdCAqLwoJCWlmICggISBwcmVnX21hdGNoKCAiL1tcMjAwLVwyMzddLyIsICRzdHJpbmcgKSBhbmQgISBwcmVnX21hdGNoKCAiL1tcMjQxLVwzNzddLyIsICRzdHJpbmcgKSApCgkJCXJldHVybiAkc3RyaW5nOwoKCQkvLyBkZWNvZGUgdGhyZWUgYnl0ZSB1bmljb2RlIGNoYXJhY3RlcnMKCQkkc3RyaW5nID0gcHJlZ19yZXBsYWNlKCAiLyhbXDM0MC1cMzU3XSkoW1wyMDAtXDI3N10pKFtcMjAwLVwyNzddKS9lIiwKCQkJIicmIycuKChvcmQoJ1xcMScpLTIyNCkqNDA5NiArIChvcmQoJ1xcMicpLTEyOCkqNjQgKyAob3JkKCdcXDMnKS0xMjgpKS4nOyciLAoJCQkkc3RyaW5nICk7CgoJCS8vIGRlY29kZSB0d28gYnl0ZSB1bmljb2RlIGNoYXJhY3RlcnMKCQkkc3RyaW5nID0gcHJlZ19yZXBsYWNlKCAiLyhbXDMwMC1cMzM3XSkoW1wyMDAtXDI3N10pL2UiLAoJCQkiJyYjJy4oKG9yZCgnXFwxJyktMTkyKSo2NCsob3JkKCdcXDInKS0xMjgpKS4nOyciLAoJCQkkc3RyaW5nICk7CgoJCXJldHVybiAkc3RyaW5nOwoJfQoKfQo=';
	}
}
